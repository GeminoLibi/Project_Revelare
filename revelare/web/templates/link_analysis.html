{% extends "base.html" %}

{% block title %}Link Analysis - Project Revelare{% endblock %}

{% block content %}
<div class="link-analysis">
    <div class="page-header">
        <h1><i class="fas fa-link"></i> Link Analysis</h1>
        <p>Visually map connections for a specific indicator across all projects.</p>
    </div>

    <div class="card">
        <h2><i class="fas fa-search"></i> Search For Connections</h2>
        <form method="POST" class="search-form">
            <div class="form-group">
                <label for="search_term">Indicator to Search For:</label>
                <input type="text" id="search_term" name="indicator" 
                       value="{{ search_term or '' }}" 
                       placeholder="Enter IP address, email, URL, etc." required>
                <div class="help-text">Find which cases a specific piece of evidence appears in and discover related cases.</div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-project-diagram"></i> Analyze Links
                </button>
            </div>
        </form>
    </div>

    {% if search_term %}
    <div class="card">
        <h2><i class="fas fa-list-ul"></i> Analysis for "{{ search_term }}"</h2>
        
        {% if results and (results.direct_links or results.secondary_links) %}
            <div class="analysis-grid">
                <div class="chart-container">
                    <h3>Connection Graph</h3>
                    <canvas id="linkChart" 
                            data-search-term="{{ results.search_term | e }}"
                            data-direct-links="{{ (results.direct_links or []) | tojson | e }}"
                            data-secondary-links="{{ (results.secondary_links or []) | tojson | e }}">
                    </canvas>
                    <div id="chart-fallback" style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Chart visualization will appear here when data is available.</p>
                    </div>
                </div>

                <div class="results-container">
                    <h3>Direct Hits</h3>
                    <p>Indicator found directly in {{ results.direct_links|length }} case(s):</p>
                    <ul class="results-list">
                        {% for project in results.direct_links %}
                        <li>
                            <i class="fas fa-folder"></i>
                            <strong>{{ project }}</strong>
                            <a href="{{ url_for('case_management', case_name=project) }}" class="btn btn-sm btn-outline">Manage</a>
                        </li>
                        {% endfor %}
                    </ul>

                    {% if results.secondary_links %}
                    <h3 style="margin-top: 2rem;">Potentially Related Cases</h3>
                    <p>These cases share other indicators with the cases listed above:</p>
                    <ul class="results-list">
                        {% for link in results.secondary_links %}
                        <li>
                            <i class="fas fa-exchange-alt"></i>
                            <div>
                                <strong>{{ link.case }}</strong>
                                <small class="text-muted">Connected to {{ link.connected_to }} via: {{ link.reason }}</small>
                            </div>
                            <a href="{{ url_for('case_management', case_name=link.case) }}" class="btn btn-sm btn-outline">Manage</a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No Results Found</h3>
                <p>The indicator "{{ search_term }}" was not found in any projects.</p>
            </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
    .link-analysis {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .analysis-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 2rem; 
        align-items: flex-start; 
        margin-top: 2rem;
    }
    
    .chart-container { 
        position: relative; 
        height: 500px; 
        background: #f8fafc; 
        border: 1px solid var(--border); 
        border-radius: 8px; 
        padding: 1rem;
        min-height: 400px;
    }
    
    .results-container {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid var(--border);
    }
    
    .results-container h3 {
        color: var(--text-light);
        margin-bottom: 1rem;
        font-family: var(--font-heading);
        font-size: 1.25rem;
    }
    
    .results-list { 
        list-style: none; 
        padding: 0; 
        margin: 0;
    }
    
    .results-list li { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
        padding: 0.75rem; 
        background: #f8fafc; 
        border-radius: 6px; 
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }
    
    .results-list li:hover {
        background: #e2e8f0;
        transform: translateX(4px);
    }
    
    .results-list li i {
        color: var(--primary);
        width: 20px;
        text-align: center;
    }
    
    .results-list li small { 
        display: block; 
        font-size: 0.8rem; 
        color: var(--text-muted);
        margin-top: 0.25rem;
    }
    
    .results-list li a { 
        margin-left: auto; 
        flex-shrink: 0;
    }
    
    .search-form {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
    }
    
    .search-form .form-group {
        margin-bottom: 1.5rem;
    }
    
    .search-form input[type="text"] {
        font-size: 1.1rem;
        padding: 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        transition: border-color 0.3s ease;
    }
    
    .search-form input[type="text"]:focus {
        border-color: var(--secondary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }
    
    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-light);
    }
    
    @media (max-width: 992px) { 
        .analysis-grid { 
            grid-template-columns: 1fr; 
            gap: 1.5rem;
        }
        
        .chart-container {
            height: 400px;
            min-height: 300px;
        }
    }
    
    @media (max-width: 768px) {
        .link-analysis {
            padding: 1rem;
        }
        
        .search-form {
            padding: 1.5rem;
        }
        
        .results-container {
            padding: 1rem;
        }
        
        .chart-container {
            height: 300px;
            min-height: 250px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% if results %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('linkChart');
    const fallback = document.getElementById('chart-fallback');
    
    if (!ctx) {
        if (fallback) fallback.style.display = 'block';
        return;
    }
    
    // Get data from data attributes to avoid template syntax issues
    const searchTerm = ctx.dataset.searchTerm || 'Unknown';
    const directLinksData = ctx.dataset.directLinks || '[]';
    const secondaryLinksData = ctx.dataset.secondaryLinks || '[]';
    
    let directLinks, secondaryLinks;
    try {
        directLinks = JSON.parse(directLinksData);
        secondaryLinks = JSON.parse(secondaryLinksData);
    } catch (e) {
        console.error('Error parsing data:', e);
        directLinks = [];
        secondaryLinks = [];
        if (fallback) fallback.style.display = 'block';
        return;
    }
    
    // Check if we have any data to display
    if (directLinks.length === 0 && secondaryLinks.length === 0) {
        if (fallback) fallback.style.display = 'block';
        return;
    }

    // Create nodes for the graph
    const nodes = {};
    const center = { x: 0, y: 0 };
    nodes[searchTerm] = { ...center, label: searchTerm, type: 'search' };

    // Position direct links in a circle around the center
    directLinks.forEach((name, i) => {
        const angle = (i / Math.max(directLinks.length, 1)) * 2 * Math.PI;
        nodes[name] = { 
            x: center.x + 2 * Math.cos(angle), 
            y: center.y + 2 * Math.sin(angle), 
            label: name, 
            type: 'direct' 
        };
    });

    // Position secondary links in an outer circle
    secondaryLinks.forEach((link, i) => {
        const name = link.case;
        if (!nodes[name]) {
            const angle = (i / Math.max(secondaryLinks.length, 1)) * 2 * Math.PI + (Math.PI / 4);
            nodes[name] = { 
                x: center.x + 4 * Math.cos(angle), 
                y: center.y + 4 * Math.sin(angle), 
                label: name, 
                type: 'secondary' 
            };
        }
    });

    // Prepare chart data
    const chartData = {
        datasets: [
            { 
                label: 'Search Term', 
                data: [nodes[searchTerm]], 
                backgroundColor: 'rgba(239, 68, 68, 0.9)', 
                pointRadius: 15, 
                pointHoverRadius: 20 
            },
            { 
                label: 'Direct Links', 
                data: directLinks.map(name => nodes[name]).filter(n => n), 
                backgroundColor: 'rgba(59, 130, 246, 0.9)', 
                pointRadius: 10, 
                pointHoverRadius: 15 
            },
            { 
                label: 'Secondary Links', 
                data: secondaryLinks.map(link => nodes[link.case]).filter(n => n && n.type === 'secondary'), 
                backgroundColor: 'rgba(107, 114, 128, 0.8)', 
                pointRadius: 8, 
                pointHoverRadius: 13 
            }
        ]
    };

    // Custom plugin to draw lines between nodes
    const drawLinesPlugin = {
        id: 'drawLines',
        afterDraw: (chart) => {
            const centerMeta = chart.getDatasetMeta(0);
            if (!centerMeta.data || !centerMeta.data.length) return;
            
            const centerPoint = centerMeta.data[0];
            const directMeta = chart.getDatasetMeta(1);
            const secondaryMeta = chart.getDatasetMeta(2);
            const lineCtx = chart.ctx;

            lineCtx.save();
            lineCtx.strokeStyle = 'rgba(107, 114, 128, 0.3)';
            lineCtx.lineWidth = 2;

            // Draw lines from center to direct links
            if (directMeta.data) {
                directMeta.data.forEach(point => {
                    lineCtx.beginPath();
                    lineCtx.moveTo(centerPoint.x, centerPoint.y);
                    lineCtx.lineTo(point.x, point.y);
                    lineCtx.stroke();
                });
            }

            // Draw lines between direct and secondary links
            if (directMeta.data && secondaryMeta.data) {
                secondaryLinks.forEach(link => {
                    const fromPoint = directMeta.data.find(p => p.$context.raw.label === link.connected_to);
                    let toPoint = secondaryMeta.data.find(p => p.$context.raw.label === link.case);
                    if (!toPoint) {
                        toPoint = directMeta.data.find(p => p.$context.raw.label === link.case);
                    }
                    
                    if (fromPoint && toPoint) {
                        lineCtx.beginPath();
                        lineCtx.moveTo(fromPoint.x, fromPoint.y);
                        lineCtx.lineTo(toPoint.x, toPoint.y);
                        lineCtx.stroke();
                    }
                });
            }
            lineCtx.restore();
        }
    };

    // Create the chart with error handling
    try {
        const linkChart = new Chart(ctx, {
            type: 'scatter',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                plugins: {
                    legend: { 
                        display: true, 
                        position: 'bottom' 
                    },
                    tooltip: { 
                        callbacks: { 
                            label: (context) => context.raw.label 
                        } 
                    }
                }
            },
            plugins: [drawLinesPlugin]
        });
    } catch (error) {
        console.error('Error creating chart:', error);
        if (fallback) fallback.style.display = 'block';
    }
});
</script>
{% endif %}
{% endblock %}