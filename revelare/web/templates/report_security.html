{% extends "base.html" %}

{% block title %}Security Report - {{ project_name }}{% endblock %}

{% block content %}
<div class="report-container">
    <header class="report-header">
        <h1><i class="fas fa-shield-alt"></i> Security Intelligence</h1>
        <p>Project: {{ project_name }}</p>
    </header>
    
    {% include 'report_nav.html' %}

    <main class="main-content">
        <div class="filters-section">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <div class="filters-grid">
                <div class="form-group">
                    <label for="typeFilter">Threat Type</label>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="malware">Malware</option>
                        <option value="phishing">Phishing</option>
                        <option value="botnet">Botnet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="severityFilter">Severity</label>
                    <select id="severityFilter">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchFilter">Search Indicator</label>
                    <input type="text" id="searchFilter" placeholder="Search...">
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-sm btn-outline" onclick="manager.clearFilters()">Clear Filters</button>
                <span id="filterStats" class="help-text"></span>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Security Threats</div>
                <div id="tableStats" class="help-text">Loading...</div>
            </div>
            <div id="tableContent">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
<script>
    let manager;
    document.addEventListener('DOMContentLoaded', function() {
        manager = new DataTableManager({
            endpoint: `/api/report/{{ project_name }}/security`,
            dataKey: 'security',
            tableContentId: 'tableContent',
            tableStatsId: 'tableStats',
            filterStatsId: 'filterStats',
            filterIds: {
                type: 'typeFilter',
                severity: 'severityFilter',
                search: 'searchFilter',
            },
            columns: [
                { key: 'indicator', label: 'Indicator' },
                { key: 'type', label: 'Type' },
                { key: 'severity', label: 'Severity' },
                { key: 'source', label: 'Source' },
                { key: 'confidence', label: 'Confidence' },
                { key: 'last_seen', label: 'Last Seen' }
            ],
            filterFunction: (item, filters) => {
                const searchLower = filters.search.toLowerCase();
                return (!filters.type || item.type === filters.type) &&
                       (!filters.severity || item.severity === filters.severity) &&
                       (!searchLower || item.indicator.toLowerCase().includes(searchLower));
            },
            renderRow: (item) => `
                <tr>
                    <td><span class="indicator-value">${item.indicator}</span></td>
                    <td><span class="badge category-default">${item.type}</span></td>
                    <td><span class="badge severity-${item.severity}">${item.severity}</span></td>
                    <td>${item.source}</td>
                    <td>${item.confidence}%</td>
                    <td>${new Date(item.last_seen).toLocaleDateString()}</td>
                </tr>
            `
        });
        manager.init();
    });
</script>
{% endblock %}