{% extends "base.html" %}

{% block title %}Technical Report - {{ project_name }}{% endblock %}

{% block content %}
<div class="report-container">
    <header class="report-header">
        <h1><i class="fas fa-cogs"></i> Technical Details</h1>
        <p>Project: {{ project_name }}</p>
    </header>
    
    {% include 'report_nav.html' %}

    <main class="main-content">
        <div class="filters-section">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <div class="filters-grid">
                <div class="form-group">
                    <label for="componentFilter">Component</label>
                    <select id="componentFilter">
                        <option value="">All Components</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="success">Success</option>
                        <option value="warning">Warning</option>
                        <option value="error">Error</option>
                        <option value="info">Info</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeFilter">Time Range</label>
                    <select id="timeFilter">
                        <option value="">All Time</option>
                        <option value="1h">Last Hour</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchFilter">Search Message</label>
                    <input type="text" id="searchFilter" placeholder="Search logs...">
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-sm btn-outline" onclick="manager.clearFilters()">Clear Filters</button>
                <span id="filterStats" class="help-text"></span>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Technical Logs</div>
                <div id="tableStats" class="help-text">Loading...</div>
            </div>
            <div id="tableContent">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
<script>
    let manager;
    document.addEventListener('DOMContentLoaded', function() {
        const checkTimeRange = (timestamp, range) => {
            if (!range) return true;
            const now = new Date();
            const itemTime = new Date(timestamp);
            const diffHours = (now - itemTime) / (1000 * 60 * 60);
            if (range === '1h') return diffHours <= 1;
            if (range === '24h') return diffHours <= 24;
            if (range === '7d') return diffHours <= 7 * 24;
            return true;
        };

        manager = new DataTableManager({
            endpoint: `/api/report/{{ project_name }}/technical`,
            dataKey: 'technical',
            tableContentId: 'tableContent',
            tableStatsId: 'tableStats',
            filterStatsId: 'filterStats',
            filterIds: {
                component: 'componentFilter',
                status: 'statusFilter',
                time: 'timeFilter',
                search: 'searchFilter',
            },
            columns: [
                { key: 'timestamp', label: 'Timestamp' },
                { key: 'component', label: 'Component' },
                { key: 'status', label: 'Status' },
                { key: 'message', label: 'Message' }
            ],
            filterFunction: (item, filters) => {
                const searchLower = filters.search.toLowerCase();
                return (!filters.component || item.component === filters.component) &&
                       (!filters.status || item.status === filters.status) &&
                       (checkTimeRange(item.timestamp, filters.time)) &&
                       (!searchLower || (item.message && item.message.toLowerCase().includes(searchLower)));
            },
            renderRow: (item) => `
                <tr>
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td><span class="badge category-default">${item.component}</span></td>
                    <td><span class="badge status-${item.status}">${item.status}</span></td>
                    <td>${item.message}</td>
                </tr>
            `
        });
        manager.init();
    });
</script>
{% endblock %}