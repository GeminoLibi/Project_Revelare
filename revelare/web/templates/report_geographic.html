{% extends "base.html" %}

{% block title %}Geographic Report - {{ project_name }}{% endblock %}

{% block content %}
<div class="report-container">
    <header class="report-header">
        <h1><i class="fas fa-globe-americas"></i> Geographic Intelligence</h1>
        <p>Project: {{ project_name }}</p>
    </header>
    
    {% include 'report_nav.html' %}

    <main class="main-content">
        <div class="filters-section">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <div class="filters-grid">
                <div class="form-group">
                    <label for="countryFilter">Country</label>
                    <select id="countryFilter"><option value="">All Countries</option></select>
                </div>
                <div class="form-group">
                    <label for="riskFilter">Risk Level</label>
                    <select id="riskFilter">
                        <option value="">All Risk Levels</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchFilter">Search IP or ASN</label>
                    <input type="text" id="searchFilter" placeholder="Search...">
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-sm btn-outline" onclick="manager.clearFilters()">Clear Filters</button>
                <span id="filterStats" class="help-text"></span>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">IP Geolocation Data</div>
                <div id="tableStats" class="help-text">Loading...</div>
            </div>
            <div id="tableContent">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
<script>
    let manager;
    document.addEventListener('DOMContentLoaded', function() {
        manager = new DataTableManager({
            endpoint: `/api/report/{{ project_name }}/geographic`,
            dataKey: 'geographic',
            tableContentId: 'tableContent',
            tableStatsId: 'tableStats',
            filterStatsId: 'filterStats',
            filterIds: {
                country: 'countryFilter',
                risk: 'riskFilter',
                search: 'searchFilter',
            },
            columns: [
                { key: 'ip', label: 'IP Address' },
                { key: 'country', label: 'Country' },
                { key: 'city', label: 'City' },
                { key: 'asn', label: 'ASN' },
                { key: 'risk', label: 'Risk Level' },
                { key: 'indicators', label: 'Indicators' }
            ],
            filterFunction: (item, filters) => {
                const searchLower = filters.search.toLowerCase();
                return (!filters.country || item.country === filters.country) &&
                       (!filters.risk || item.risk === filters.risk) &&
                       (!searchLower || 
                        item.ip.toLowerCase().includes(searchLower) ||
                        item.asn.toLowerCase().includes(searchLower));
            },
            renderRow: (item) => `
                <tr>
                    <td><span class="indicator-value">${item.ip}</span></td>
                    <td>${item.country}</td>
                    <td>${item.city}</td>
                    <td>${item.asn}</td>
                    <td><span class="badge severity-${item.risk}">${item.risk}</span></td>
                    <td>${item.indicators}</td>
                </tr>
            `
        });
        manager.init();
    });
</script>
{% endblock %}