<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #1E293B;
            border-top: 4px solid #3B82F6;
        }
        .article-card {
            background-color: #1E293B;
            border-left: 4px solid #10B981;
            transition: all 0.3s ease;
        }
        .article-card:hover {
            background-color: #334155;
            transform: translateY(-2px);
        }
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .category-general { background-color: #3B82F6; color: white; }
        .category-security { background-color: #EF4444; color: white; }
        .category-api { background-color: #10B981; color: white; }
        .category-technical { background-color: #F59E0B; color: white; }
        .category-billing { background-color: #8B5CF6; color: white; }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <main class="pt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Knowledge Base</h1>
                <p class="text-gray-400">Find answers to common questions and learn how to use Project Revelare</p>
            </div>

            <!-- Search and Filters -->
            <div class="card p-6 rounded-lg mb-8">
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Search Articles</label>
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Search for help..." 
                                   class="w-full px-4 py-2 pl-10 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                    </div>
                    <div class="md:w-48">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Category</label>
                        <select id="categoryFilter" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Categories</option>
                            <option value="general">General</option>
                            <option value="security">Security</option>
                            <option value="api">API</option>
                            <option value="technical">Technical</option>
                            <option value="billing">Billing</option>
                        </select>
                    </div>
                    <div class="md:w-32">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Sort By</label>
                        <select id="sortFilter" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="popular">Most Popular</option>
                            <option value="recent">Most Recent</option>
                            <option value="helpful">Most Helpful</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Articles Grid -->
            <div id="articlesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Articles will be loaded here -->
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="text-gray-400 mt-4">Loading articles...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-xl font-semibold text-white mb-2">No articles found</h3>
                <p class="text-gray-400">Try adjusting your search terms or filters</p>
            </div>
        </div>
    </main>

    <!-- Article Modal -->
    <div id="articleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h2 id="modalTitle" class="text-2xl font-bold text-white"></h2>
                <button onclick="closeArticleModal()" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="modalContent" class="prose prose-invert max-w-none">
                    <!-- Article content will be loaded here -->
                </div>
            </div>
            <div class="p-6 border-t border-gray-700">
                <div class="flex justify-between items-center">
                    <div class="flex space-x-4">
                        <button onclick="markArticleHelpful(true)" class="flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
                            <i class="fas fa-thumbs-up"></i>
                            <span>Helpful</span>
                        </button>
                        <button onclick="markArticleHelpful(false)" class="flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition">
                            <i class="fas fa-thumbs-down"></i>
                            <span>Not Helpful</span>
                        </button>
                    </div>
                    <div class="text-sm text-gray-400">
                        <span id="articleStats"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load navigation
        fetch('/components/navigation.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('navigation-container').innerHTML = html;
                
                // Load navigation JavaScript after component is loaded
                const script = document.createElement('script');
                script.src = '/js/navigation.js';
                document.head.appendChild(script);
            });

        const API_BASE_URL = 'https://project-revelare-backend.liberatorgeminorum.workers.dev';
        let currentArticleId = null;

        // Load articles on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadArticles();
            
            // Add event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(loadArticles, 300));
            document.getElementById('categoryFilter').addEventListener('change', loadArticles);
            document.getElementById('sortFilter').addEventListener('change', loadArticles);
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function loadArticles() {
            const searchTerm = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortFilter').value;

            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('articlesContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            try {
                let url = `${API_BASE_URL}/api/knowledge-base?`;
                const params = new URLSearchParams();
                
                if (searchTerm) params.append('search', searchTerm);
                if (category) params.append('category', category);
                
                url += params.toString();

                const response = await fetch(url);
                const data = await response.json();

                document.getElementById('loadingState').classList.add('hidden');

                if (data.success && data.articles.length > 0) {
                    displayArticles(data.articles, sortBy);
                    document.getElementById('articlesContainer').classList.remove('hidden');
                } else {
                    document.getElementById('emptyState').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error loading articles:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        function displayArticles(articles, sortBy) {
            const container = document.getElementById('articlesContainer');
            
            // Sort articles
            if (sortBy === 'popular') {
                articles.sort((a, b) => (b.view_count || 0) - (a.view_count || 0));
            } else if (sortBy === 'recent') {
                articles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (sortBy === 'helpful') {
                articles.sort((a, b) => (b.helpful_count || 0) - (a.helpful_count || 0));
            }

            container.innerHTML = articles.map(article => `
                <div class="article-card p-6 rounded-lg cursor-pointer" onclick="openArticle(${article.id})">
                    <div class="flex justify-between items-start mb-3">
                        <span class="category-badge category-${article.category}">${article.category.charAt(0).toUpperCase() + article.category.slice(1)}</span>
                        <div class="text-sm text-gray-400">
                            <i class="fas fa-eye mr-1"></i>${article.view_count || 0}
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">${article.title}</h3>
                    <p class="text-gray-400 text-sm mb-4 line-clamp-3">${article.content.substring(0, 150)}...</p>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>By ${article.firstName} ${article.lastName}</span>
                        <span>${new Date(article.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="mt-3 flex items-center space-x-4 text-sm">
                        <div class="flex items-center text-green-400">
                            <i class="fas fa-thumbs-up mr-1"></i>
                            ${article.helpful_count || 0}
                        </div>
                        <div class="flex items-center text-red-400">
                            <i class="fas fa-thumbs-down mr-1"></i>
                            ${article.not_helpful_count || 0}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function openArticle(articleId) {
            currentArticleId = articleId;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/knowledge-base/${articleId}`);
                const data = await response.json();

                if (data.success) {
                    const article = data.article;
                    
                    document.getElementById('modalTitle').textContent = article.title;
                    document.getElementById('modalContent').innerHTML = `
                        <div class="mb-4">
                            <span class="category-badge category-${article.category}">${article.category.charAt(0).toUpperCase() + article.category.slice(1)}</span>
                            <span class="text-gray-400 text-sm ml-4">By ${article.firstName} ${article.lastName}</span>
                        </div>
                        <div class="prose prose-invert max-w-none">
                            ${article.content.replace(/\n/g, '<br>')}
                        </div>
                    `;
                    
                    document.getElementById('articleStats').textContent = 
                        `${article.view_count || 0} views • ${article.helpful_count || 0} helpful • ${article.not_helpful_count || 0} not helpful`;
                    
                    document.getElementById('articleModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Error loading article');
            }
        }

        function closeArticleModal() {
            document.getElementById('articleModal').classList.add('hidden');
            currentArticleId = null;
        }

        async function markArticleHelpful(helpful) {
            if (!currentArticleId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/knowledge-base/${currentArticleId}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ helpful })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Reload articles to update counts
                    loadArticles();
                    
                    // Show feedback
                    const button = helpful ? 
                        document.querySelector('button[onclick="markArticleHelpful(true)"]') :
                        document.querySelector('button[onclick="markArticleHelpful(false)"]');
                    
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i><span>Thank you!</span>';
                    button.classList.add('opacity-50');
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('opacity-50');
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeArticleModal();
            }
        });
    </script>
</body>
</html>

