<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroWave Composer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tonaljs/tonal/browser/tonal.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            text-shadow: 2px 2px #000;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .control-panel {
            background-color: #162447;
            border: 4px solid #1f4068;
            box-shadow: 0 0 15px rgba(27, 94, 154, 0.5), inset 0 0 10px rgba(0,0,0,0.5);
        }
        .section-box {
            background-color: rgba(0,0,0,0.2);
            border: 2px solid #1f4068;
            border-radius: 8px;
            padding: 1rem;
        }
        .btn {
            background-color: #1f4068;
            border: 2px solid #e43f5a;
            color: #f6f6f6;
            transition: all 0.2s ease;
            box-shadow: 4px 4px #000;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #e43f5a;
            border-color: #1f4068;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px #000;
        }
         .btn:active, .btn.active-force {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px #000;
        }
        .btn.active {
            background-color: #e43f5a;
            border-color: #1f4068;
        }
        select, input[type=range] {
            background-color: #1b1b2f;
            border: 2px solid #1f4068;
            color: #e0e0e0;
            -webkit-appearance: none;
            appearance: none;
            border-radius: 0;
            padding: 0.5rem;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #e43f5a;
            border: 2px solid #1f4068;
            cursor: pointer;
            box-shadow: 2px 2px #000;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #e43f5a;
            border: 2px solid #1f4068;
            cursor: pointer;
            box-shadow: 2px 2px #000;
        }
        .led { 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            background-color: #333; 
            border: 2px solid #000; 
            transition: background-color 0.1s; 
        }
        .led.on { 
            background-color: #ff0000; 
            box-shadow: 0 0 10px #ff0000; 
        }
        label { 
            text-shadow: 1px 1px #000; 
            font-size: 0.7rem;
        }
        .section-title {
            color: #00d9ff;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            text-shadow: 2px 2px #000, 0 0 10px rgba(0,217,255,0.5);
        }
        .sequence-part { 
            transition: all 0.3s; 
            display: inline-block;
            padding: 0.25rem 0.5rem;
        }
        .sequence-part.playing { 
            color: #ff0000; 
            text-shadow: 0 0 10px #ff0000;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="w-full min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-7xl mx-auto">
        <h1 class="text-4xl md:text-5xl text-center mb-2 text-cyan-300 animate-pulse" style="text-shadow: 3px 3px #e43f5a, 0 0 20px rgba(0,255,255,0.5);">RetroWave Composer</h1>
        <p class="text-center mb-6 text-xs">Procedural 16-Bit Music â€¢ <span id="variation-counter" class="text-cyan-400">0</span> variations</p>

        <div class="control-panel p-4 md:p-6 rounded-lg space-y-4">
            <!-- Control Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <button id="play-btn" class="btn p-3 text-lg">â–¶ Play</button>
                <button id="stop-btn" class="btn p-3 text-lg">â–  Stop</button>
                <button id="evolve-btn" class="btn p-3 text-lg bg-cyan-600 border-cyan-400 hover:bg-cyan-400">âš¡ Evolve</button>
                <button id="randomize-btn" class="btn p-3 text-lg col-span-2 bg-purple-600 border-purple-400 hover:bg-purple-400">ðŸŽ² Randomize All</button>
            </div>
            
            <!-- Status Display -->
            <div class="section-box">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center space-x-3">
                        <span class="text-xs">STATUS:</span>
                        <span id="status-text" class="text-yellow-300 text-sm">IDLE</span>
                    </div>
                    <div class="flex space-x-2">
                        <div id="led-1" class="led"></div>
                        <div id="led-2" class="led"></div>
                        <div id="led-3" class="led"></div>
                        <div id="led-4" class="led"></div>
                    </div>
                    <div id="structure-display" class="text-cyan-400 text-xs">SEQUENCE: --</div>
                    <div id="chord-display" class="text-pink-400 text-xs">CHORD: --</div>
                    <div id="debug-display" class="text-green-400 text-xs">Ready to generate music...</div>
                </div>
            </div>

            <!-- Main Control Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Style Section -->
                <div class="space-y-4">
                    <div class="section-box">
                        <h2 class="section-title">Style</h2>
                        <div class="space-y-2">
                            <div>
                                <label class="block mb-1">Genre</label>
                                <select id="genre-select" class="w-full"></select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block mb-1">Key</label>
                                    <select id="key-select" class="w-full">
                                        <option>C</option><option>C#</option><option>D</option><option>D#</option>
                                        <option>E</option><option>F</option><option>F#</option><option>G</option>
                                        <option>G#</option><option>A</option><option>A#</option><option>B</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block mb-1">Scale</label>
                                    <select id="scale-select" class="w-full">
                                        <option>major</option><option>minor</option><option>dorian</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-box">
                        <h2 class="section-title">Dynamics</h2>
                        <div class="space-y-3">
                            <div>
                                <label>BPM: <span id="bpm-value" class="text-cyan-400">120</span></label>
                                <input type="range" id="bpm-slider" min="60" max="240" value="120" class="w-full mt-1">
                            </div>
                            <div>
                                <label>Intensity: <span id="intensity-value" class="text-cyan-400">5</span></label>
                                <input type="range" id="intensity-slider" min="0" max="10" value="5" class="w-full mt-1">
                            </div>
                            <div>
                                <label>Syncopation: <span id="syncopation-value" class="text-cyan-400">2</span></label>
                                <input type="range" id="syncopation-slider" min="0" max="10" value="2" class="w-full mt-1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sound Design Section -->
                <div class="space-y-4">
                    <div class="section-box">
                        <h2 class="section-title">Sound Design</h2>
                        <div class="space-y-3">
                            <div>
                                <label class="block mb-1">Lead Wave</label>
                                <div id="lead-wave-btns" class="grid grid-cols-2 gap-2">
                                    <button class="btn p-2 text-xs active" data-wave="pulse">Square</button>
                                    <button class="btn p-2 text-xs" data-wave="sawtooth">Saw</button>
                                    <button class="btn p-2 text-xs" data-wave="triangle">Triangle</button>
                                    <button class="btn p-2 text-xs" data-wave="fmsine">Sine</button>
                                </div>
                            </div>
                            <div>
                                <label class="block mb-1">Bass Wave</label>
                                <div id="bass-wave-btns" class="grid grid-cols-2 gap-2">
                                    <button class="btn p-2 text-xs active" data-wave="triangle">Triangle</button>
                                    <button class="btn p-2 text-xs" data-wave="sawtooth">Saw</button>
                                </div>
                            </div>
                            <div>
                                <label>Stereo Width: <span id="stereo-value" class="text-cyan-400">5</span></label>
                                <input type="range" id="stereo-slider" min="0" max="10" value="5" class="w-full mt-1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-box">
                        <h2 class="section-title">FX Rack</h2>
                        <div class="space-y-3">
                            <div>
                                <label>Reverb: <span id="reverb-value" class="text-cyan-400">0.0</span></label>
                                <input type="range" id="reverb-slider" min="0" max="10" value="0" class="w-full mt-1">
                            </div>
                            <div>
                                <label>Delay: <span id="delay-value" class="text-cyan-400">0.0</span></label>
                                <input type="range" id="delay-slider" min="0" max="10" value="0" class="w-full mt-1">
                            </div>
                            <div>
                                <label>Filter: <span id="filter-value" class="text-cyan-400">10</span></label>
                                <input type="range" id="filter-slider" min="1" max="10" value="10" class="w-full mt-1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mixer Section -->
                <div class="section-box">
                    <h2 class="section-title">Mixer</h2>
                    <div id="mixer-controls" class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <button class="btn p-2 text-xs active w-20" data-track="lead">Lead</button>
                            <input type="range" min="-30" max="6" value="0" step="1" class="flex-1" data-volume="lead">
                            <span class="text-xs w-16 text-right" data-volume-label="lead">0 dB</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="btn p-2 text-xs active w-20" data-track="bass">Bass</button>
                            <input type="range" min="-30" max="6" value="0" step="1" class="flex-1" data-volume="bass">
                            <span class="text-xs w-16 text-right" data-volume-label="bass">0 dB</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="btn p-2 text-xs active w-20" data-track="arp">Arp</button>
                            <input type="range" min="-30" max="6" value="-12" step="1" class="flex-1" data-volume="arp">
                            <span class="text-xs w-16 text-right" data-volume-label="arp">-12 dB</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="btn p-2 text-xs active w-20" data-track="drums">Drums</button>
                            <input type="range" min="-30" max="6" value="0" step="1" class="flex-1" data-volume="drums">
                            <span class="text-xs w-16 text-right" data-volume-label="drums">0 dB</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing RetroWave Composer...');
    
    // --- TONE.JS SETUP ---
    let synths = {}, effects = {}, panners = {}, audioReady = false;
    let conductor = null, activeParts = {};
    const SECTION_LENGTH = '4m';

    function setupAudio() {
        if (audioReady) return;
        console.log('Setting up audio...');
        
        // Initialize audio context if needed
        if (!window.AudioContext && !window.webkitAudioContext) {
            console.error('Web Audio API not supported');
            return;
        }
        
        effects.reverb = new Tone.Reverb({ decay: 1.5, wet: 0 }).toDestination();
        effects.delay = new Tone.FeedbackDelay("8n", 0.5).connect(effects.reverb);
        effects.delay.wet.value = 0;
        effects.filter = new Tone.Filter(20000, "lowpass").connect(effects.delay);

        panners.lead = new Tone.Panner(0).connect(effects.filter);
        synths.lead = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "pulse" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 }
        }).connect(panners.lead);
        synths.lead.volume.value = 0;
        
        panners.bass = new Tone.Panner(0).connect(effects.filter);
        synths.bass = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.5 }
        }).connect(panners.bass);
        synths.bass.volume.value = 0;
        
        panners.arp = new Tone.Panner(0).connect(effects.filter);
        synths.arp = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sawtooth" },
            envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
        }).connect(panners.arp);
        synths.arp.volume.value = -12;
        
        panners.kick = new Tone.Panner(0).connect(effects.filter);
        synths.kick = new Tone.MembraneSynth({
            pitchDecay: 0.05,
            octaves: 10,
            oscillator: { type: 'sine' },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        }).connect(panners.kick);

        panners.snare = new Tone.Panner(0).connect(effects.filter);
        synths.snare = new Tone.NoiseSynth({
            noise: { type: 'white' },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
        }).connect(panners.snare);
        synths.snare.volume.value = -10;
        
        panners.hihat = new Tone.Panner(0).connect(effects.filter);
        synths.hihat = new Tone.NoiseSynth({
            noise: { type: 'pink' },
            envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
        }).connect(panners.hihat);
        synths.hihat.volume.value = -18;

        audioReady = true;
        console.log('Audio setup complete!');
    }

    // --- UI ELEMENTS ---
    const ui = {
        playBtn: document.getElementById('play-btn'),
        stopBtn: document.getElementById('stop-btn'),
        evolveBtn: document.getElementById('evolve-btn'),
        randomizeBtn: document.getElementById('randomize-btn'),
        genreSelect: document.getElementById('genre-select'),
        keySelect: document.getElementById('key-select'),
        scaleSelect: document.getElementById('scale-select'),
        bpmSlider: document.getElementById('bpm-slider'),
        bpmValue: document.getElementById('bpm-value'),
        intensitySlider: document.getElementById('intensity-slider'),
        intensityValue: document.getElementById('intensity-value'),
        syncopationSlider: document.getElementById('syncopation-slider'),
        syncopationValue: document.getElementById('syncopation-value'),
        stereoSlider: document.getElementById('stereo-slider'),
        stereoValue: document.getElementById('stereo-value'),
        leadWaveBtns: document.getElementById('lead-wave-btns'),
        bassWaveBtns: document.getElementById('bass-wave-btns'),
        statusText: document.getElementById('status-text'),
        leds: [document.getElementById('led-1'), document.getElementById('led-2'), document.getElementById('led-3'), document.getElementById('led-4')],
        mixerControls: document.getElementById('mixer-controls'),
        reverbSlider: document.getElementById('reverb-slider'),
        reverbValue: document.getElementById('reverb-value'),
        delaySlider: document.getElementById('delay-slider'),
        delayValue: document.getElementById('delay-value'),
        filterSlider: document.getElementById('filter-slider'),
        filterValue: document.getElementById('filter-value'),
        structureDisplay: document.getElementById('structure-display'),
        chordDisplay: document.getElementById('chord-display'),
        debugDisplay: document.getElementById('debug-display'),
        variationCounter: document.getElementById('variation-counter')
    };
    
    // --- MUSIC DATA ---
    const musicData = {
        'Neon Drive': {
            bpm: 130,
            key: 'C',
            scale: 'minor',
            patterns: {
                lead: [
                    // Main synth lead pattern - A minor pentatonic
                    [
                        { freq: 440, duration: 0.125 }, // A4
                        { freq: 523, duration: 0.125 }, // C5
                        { freq: 659, duration: 0.25 },  // E5
                        { freq: 523, duration: 0.125 }, // C5
                        { freq: 440, duration: 0.125 }, // A4
                        { freq: 349, duration: 0.25 },  // F4
                        { freq: 440, duration: 0.5 },   // A4
                    ],
                    // High arpeggio pattern
                    [
                        { freq: 880, duration: 0.125 }, // A5
                        { freq: 1047, duration: 0.125 }, // C6
                        { freq: 1319, duration: 0.125 }, // E6
                        { freq: 1047, duration: 0.125 }, // C6
                        { freq: 880, duration: 0.125 }, // A5
                        { freq: 698, duration: 0.125 }, // F5
                        { freq: 880, duration: 0.25 },  // A5
                    ]
                ],
                bass: [
                    // Bass line pattern
                    [
                        { freq: 220, duration: 0.25 },  // A3
                        { freq: 262, duration: 0.25 },  // C4
                        { freq: 330, duration: 0.25 },  // E4
                        { freq: 262, duration: 0.25 },  // C4
                    ],
                    // Syncopated bass
                    [
                        { freq: 220, duration: 0.125 }, // A3
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 262, duration: 0.25 },  // C4
                        { freq: 330, duration: 0.125 }, // E4
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 220, duration: 0.25 },  // A3
                    ]
                ],
                drums: [
                    // Kick and snare pattern
                    [
                        { freq: 60, duration: 0.25 },   // Kick
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 80, duration: 0.125 },  // Snare
                        { freq: 60, duration: 0.25 },   // Kick
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 80, duration: 0.125 },  // Snare
                    ]
                ]
            }
        },
        'JRPG Battle': {
            bpm: 160,
            key: 'G',
            scale: 'minor',
            patterns: {
                lead: [
                    // Heroic melody - G minor
                    [
                        { freq: 523, duration: 0.125 }, // C5
                        { freq: 659, duration: 0.125 }, // E5
                        { freq: 784, duration: 0.25 },  // G5
                        { freq: 659, duration: 0.125 }, // E5
                        { freq: 523, duration: 0.125 }, // C5
                        { freq: 440, duration: 0.25 },  // A4
                        { freq: 523, duration: 0.5 },   // C5
                    ],
                    // Fast arpeggio
                    [
                        { freq: 1047, duration: 0.0625 }, // C6
                        { freq: 1319, duration: 0.0625 }, // E6
                        { freq: 1568, duration: 0.0625 }, // G6
                        { freq: 1319, duration: 0.0625 }, // E6
                        { freq: 1047, duration: 0.0625 }, // C6
                        { freq: 880, duration: 0.0625 },  // A5
                        { freq: 1047, duration: 0.125 },  // C6
                    ]
                ],
                bass: [
                    // Marching bass
                    [
                        { freq: 262, duration: 0.25 },  // C4
                        { freq: 262, duration: 0.25 },  // C4
                        { freq: 330, duration: 0.25 },  // E4
                        { freq: 262, duration: 0.25 },  // C4
                    ]
                ],
                drums: [
                    // Battle drums
                    [
                        { freq: 60, duration: 0.125 },  // Kick
                        { freq: 0, duration: 0.0625 },  // Rest
                        { freq: 80, duration: 0.0625 }, // Snare
                        { freq: 60, duration: 0.125 },  // Kick
                        { freq: 0, duration: 0.0625 },  // Rest
                        { freq: 80, duration: 0.0625 }, // Snare
                        { freq: 60, duration: 0.125 },  // Kick
                        { freq: 80, duration: 0.125 },  // Snare
                    ]
                ]
            }
        },
        'Cyberpunk City': {
            bpm: 110,
            key: 'F',
            scale: 'dorian',
            patterns: {
                lead: [
                    // Dark synth lead - F dorian
                    [
                        { freq: 349, duration: 0.125 }, // F4
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 440, duration: 0.125 }, // A4
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 523, duration: 0.25 },  // C5
                        { freq: 440, duration: 0.125 }, // A4
                        { freq: 349, duration: 0.25 },  // F4
                    ],
                    // Glitchy arpeggio
                    [
                        { freq: 698, duration: 0.0625 }, // F5
                        { freq: 880, duration: 0.0625 }, // A5
                        { freq: 1047, duration: 0.0625 }, // C6
                        { freq: 880, duration: 0.0625 }, // A5
                        { freq: 698, duration: 0.0625 }, // F5
                        { freq: 0, duration: 0.0625 },   // Rest
                        { freq: 698, duration: 0.125 }, // F5
                    ]
                ],
                bass: [
                    // Deep bass line
                    [
                        { freq: 175, duration: 0.25 },  // F3
                        { freq: 175, duration: 0.25 },  // F3
                        { freq: 220, duration: 0.25 },  // A3
                        { freq: 175, duration: 0.25 },  // F3
                    ]
                ],
                drums: [
                    // Cyberpunk beat
                    [
                        { freq: 60, duration: 0.125 },  // Kick
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 80, duration: 0.125 },  // Snare
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 60, duration: 0.125 },  // Kick
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 80, duration: 0.125 },  // Snare
                        { freq: 0, duration: 0.125 },   // Rest
                    ]
                ]
            }
        },
        'Serene Town': {
            bpm: 90,
            key: 'D',
            scale: 'major',
            patterns: {
                lead: [
                    // Peaceful melody - D major
                    [
                        { freq: 587, duration: 0.25 },  // D5
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 659, duration: 0.125 }, // E5
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 740, duration: 0.25 },  // F#5
                        { freq: 0, duration: 0.125 },   // Rest
                        { freq: 659, duration: 0.25 },  // E5
                    ],
                    // Gentle arpeggio
                    [
                        { freq: 1175, duration: 0.125 }, // D6
                        { freq: 1319, duration: 0.125 }, // E6
                        { freq: 1480, duration: 0.125 }, // F#6
                        { freq: 1319, duration: 0.125 }, // E6
                        { freq: 1175, duration: 0.125 }, // D6
                        { freq: 1047, duration: 0.125 }, // C6
                        { freq: 1175, duration: 0.25 },  // D6
                    ]
                ],
                bass: [
                    // Soft bass
                    [
                        { freq: 294, duration: 0.5 },   // D4
                        { freq: 330, duration: 0.5 },   // E4
                        { freq: 370, duration: 0.5 },   // F#4
                        { freq: 330, duration: 0.5 },   // E4
                    ]
                ],
                drums: [
                    // Light drums
                    [
                        { freq: 60, duration: 0.25 },   // Kick
                        { freq: 0, duration: 0.25 },    // Rest
                        { freq: 80, duration: 0.25 },   // Snare
                        { freq: 0, duration: 0.25 },    // Rest
                    ]
                ]
            }
        }
    };
    
    // --- GENERATIVE STATE ---
    let generatedSections = {};
    let sectionHistory = [];
    let currentSectionIndex = 0;
    let nextSectionLetterCode = 65;
    let forceNextNew = false;
    let isPlaying = false;
    let preGeneratedSection = { id: null, data: null };
    let variationCount = 0;
    let currentChordProgression = [];

    // --- CHORD PROGRESSION SYSTEM ---
    function generateChordProgression(key, scale) {
        console.log('Generating chord progression for key:', key, 'scale:', scale);
        const progressions = {
            major: [
                ['I', 'IV', 'V', 'I'],      // Classic I-IV-V-I
                ['I', 'vi', 'IV', 'V'],     // Pop progression
                ['I', 'V', 'vi', 'IV'],     // Axis of Awesome
                ['ii', 'V', 'I', 'I']       // Jazz turnaround
            ],
            minor: [
                ['i', 'iv', 'v', 'i'],      // Natural minor
                ['i', 'VI', 'III', 'VII'],  // Harmonic minor
                ['i', 'iv', 'VII', 'III'],  // Alternative rock
                ['i', 'VI', 'iv', 'v']      // Melancholic
            ],
            dorian: [
                ['i', 'IV', 'v', 'i'],      // Dorian staple
                ['i', 'VII', 'IV', 'IV'],   // Dorian groove
                ['i', 'iv', 'v', 'i'],      // Minor with dorian twist
                ['i', 'VI', 'III', 'VII']   // Dorian extended
            ]
        };

        const scaleProgressions = progressions[scale] || progressions.major;
        const selectedProgression = scaleProgressions[Math.floor(Math.random() * scaleProgressions.length)];
        console.log('Selected progression:', selectedProgression);
        return selectedProgression;
    }

    // --- MUSIC THEORY & HELPERS ---
    const randEl = (arr) => arr[Math.floor(Math.random() * arr.length)];
    
    // Map frequencies to scale notes
    function mapFrequencyToScale(freq, key, scale) {
        if (freq === 0) return null; // Rest
        
        // Get the scale notes
        const scaleInfo = Tonal.Scale.get(`${key} ${scale}`);
        const scaleNotes = scaleInfo.notes;
        
        // Find the closest note in the scale
        const noteName = Tonal.Freq.get(freq).note;
        const octave = Tonal.Freq.get(freq).oct;
        
        // Check if the note is in the scale
        const baseNote = noteName.replace(/\d+/, '');
        const scaleIndex = scaleNotes.findIndex(note => note.replace(/\d+/, '') === baseNote);
        
        if (scaleIndex !== -1) {
            return `${scaleNotes[scaleIndex]}${octave}`;
        } else {
            // If not in scale, find the closest scale note
            const closestNote = scaleNotes[0]; // Default to root
            return `${closestNote}${octave}`;
        }
    }
    
    function getChordFromRoman(numeral, key, scale) {
        const scaleInfo = Tonal.Scale.get(`${key} ${scale}`);
        const scaleChords = scaleInfo.chords;
        const roman = Tonal.RomanNumeral.get(numeral);
        const degree = roman.major ? roman.majorDegree : roman.degree;
        return degree > 0 && degree <= scaleChords.length ? scaleChords[degree - 1] : `${key}M`;
    }
    
    function getNoteFromDegree(degree, chordNotes) {
        if (degree === null || degree === "-") return null;
        const degreeStr = String(degree);
        const degreeNum = parseInt(degreeStr.replace(/[^\d]/g, ""));
        const index = (degreeNum - 1) % chordNotes.length;
        
        if (isNaN(index) || !chordNotes[index]) return null;
        
        let note = chordNotes[index];
        if (degreeStr.includes("b")) note = Tonal.Note.transpose(note, "-2m");
        if (degreeStr.includes("#")) note = Tonal.Note.transpose(note, "2m");
        if (degreeStr.includes("8")) note = Tonal.Note.transpose(chordNotes[0], "8P");
        if (degreeStr.includes("10")) note = Tonal.Note.transpose(chordNotes[2 % chordNotes.length], "8P");
        
        return note;
    }
    
    function generatePart(trackArray, pattern, chordNotes) {
        if (!pattern || !pattern.p || !pattern.p[0]) return;
        const degrees = pattern.p[0];
        const subdivision = degrees.length;
        
        degrees.forEach((degree, idx) => {
            const timeStr = `0:0:${idx * (16 / subdivision)}`;
            const note = getNoteFromDegree(degree, chordNotes);
            if (note) {
                trackArray.push({ time: timeStr, note: note, duration: pattern.d });
            }
        });
    }

    // --- CORE GENERATION LOGIC ---
    function generateSectionData() {
        console.log('Generating new section...');
        const genreData = musicData[ui.genreSelect.value];
        const intensity = parseInt(ui.intensitySlider.value);
        const syncopation = parseInt(ui.syncopationSlider.value);
        const key = ui.keySelect.value;
        const scale = ui.scaleSelect.value;
        
        let sectionTrack = { lead: [], bass: [], drums: [], arp: [] };
        variationCount++;
        ui.variationCounter.textContent = variationCount;

        // --- SIMPLIFIED PATTERN-BASED GENERATION ---
        // Always include instruments based on intensity
        const hasLead = intensity > 1;
        const hasBass = intensity > 0;
        const hasDrums = true; // Always include drums

        // Select patterns randomly from the genre's patterns
        if (hasLead) {
            const leadPatterns = genreData.patterns.lead;
            const selectedLeadPattern = leadPatterns[Math.floor(Math.random() * leadPatterns.length)];
            sectionTrack.lead = [...selectedLeadPattern]; // Copy the pattern directly
        }
        
        if (hasBass) {
            const bassPatterns = genreData.patterns.bass;
            const selectedBassPattern = bassPatterns[Math.floor(Math.random() * bassPatterns.length)];
            sectionTrack.bass = [...selectedBassPattern]; // Copy the pattern directly
        }
        
        if (hasDrums) {
            const drumPatterns = genreData.patterns.drums;
            const selectedDrumPattern = drumPatterns[Math.floor(Math.random() * drumPatterns.length)];
            sectionTrack.drums = [...selectedDrumPattern]; // Copy the pattern directly
        }
        
        console.log('Generated section:', sectionTrack);
        ui.debugDisplay.textContent = `Generated: ${sectionTrack.lead.length} lead, ${sectionTrack.bass.length} bass, ${sectionTrack.drums.length} drums`;
        return sectionTrack;
    }
    
    function generateNextSectionInBackground() {
        const newId = String.fromCharCode(nextSectionLetterCode);
        const data = generateSectionData();
        preGeneratedSection = { id: newId, data: data };
    }

    function decideNextSection() {
        const existingIds = Object.keys(generatedSections);
        
        if (!forceNextNew && existingIds.length > 2 && Math.random() < 0.7) {
            sectionHistory.push(randEl(existingIds));
            return;
        }
        
        if (preGeneratedSection.id && preGeneratedSection.data) {
            const newId = preGeneratedSection.id;
            generatedSections[newId] = preGeneratedSection.data;
            sectionHistory.push(newId);
            
            nextSectionLetterCode++;
            preGeneratedSection = { id: null, data: null };
            forceNextNew = false;
            
            generateNextSectionInBackground();
        } else {
            sectionHistory.push(randEl(existingIds.length ? existingIds : ['A']));
        }
    }

    function playSection(time, sectionId) {
        console.log('Playing section:', sectionId);
        Object.values(activeParts).forEach(p => { 
            p.stop(time); 
            p.dispose(); 
        });
        activeParts = {};
        
        const trackData = generatedSections[sectionId];
        if (!trackData) {
            console.log('No track data for section:', sectionId);
            return;
        }

        const width = ui.stereoSlider.value / 10;
        
        const playMelodicWithPan = (synth, panner, freq, duration, time) => {
            const panValue = (Math.random() * 2 - 1) * width;
            if (panner && panner.pan) panner.pan.rampTo(panValue, 0.05, time);
            // Create a frequency object for Tone.js
            const frequency = new Tone.Frequency(freq);
            synth.triggerAttackRelease(frequency, duration, time);
        };

        const playDrumWithPan = (synth, panner, freq, duration, time) => {
            const panValue = (Math.random() * 2 - 1) * width;
            if (panner && panner.pan) panner.pan.rampTo(panValue, 0.05, time);
            // Create a frequency object for Tone.js
            const frequency = new Tone.Frequency(freq);
            synth.triggerAttackRelease(frequency, duration, time);
        };
        
        // Convert patterns to Tone.Part format - EXACTLY like neon gumshoe
        const convertPatternToPart = (pattern, startTime = 0) => {
            const part = [];
            let currentTime = startTime;
            pattern.forEach(note => {
                if (note.freq > 0) { // Skip rests (freq = 0)
                    part.push({ time: currentTime, freq: note.freq, duration: note.duration });
                }
                currentTime += note.duration;
            });
            return part;
        };
        
        // Lead
        if (trackData.lead && trackData.lead.length > 0) {
            console.log('Creating lead part with', trackData.lead.length, 'notes');
            const leadPart = convertPatternToPart(trackData.lead);
            activeParts.lead = new Tone.Part((t, v) => {
                playMelodicWithPan(synths.lead, panners.lead, v.freq, v.duration, t);
            }, leadPart).start(time);
            ui.debugDisplay.textContent = `Playing: ${leadPart.length} lead notes, ${trackData.bass.length} bass, ${trackData.drums.length} drums`;
        }
        
        // Bass
        if (trackData.bass && trackData.bass.length > 0) {
            console.log('Creating bass part with', trackData.bass.length, 'notes');
            const bassPart = convertPatternToPart(trackData.bass);
            activeParts.bass = new Tone.Part((t, v) => {
                playMelodicWithPan(synths.bass, panners.bass, v.freq, v.duration, t);
            }, bassPart).start(time);
        }
        
        // Drums
        if (trackData.drums && trackData.drums.length > 0) {
            console.log('Creating drums part with', trackData.drums.length, 'notes');
            const drumsPart = convertPatternToPart(trackData.drums);
            activeParts.drums = new Tone.Part((t, v) => {
                if (v.freq < 100) {
                    playMelodicWithPan(synths.kick, panners.kick, v.freq, v.duration, t);
                } else {
                    playDrumWithPan(synths.snare, panners.snare, v.freq, v.duration, t);
                }
            }, drumsPart).start(time);
        }

        // Apply mute states
        Object.keys(activeParts).forEach(key => {
            const muteBtn = ui.mixerControls.querySelector(`[data-track="${key}"]`);
            if (muteBtn && !muteBtn.classList.contains('active')) {
                activeParts[key].mute = true;
            }
        });
    }

    function updateVisuals() {
        if (!isPlaying) return;
        
        const fullSequence = sectionHistory.map((id, idx) => 
            `<span class="sequence-part ${idx === currentSectionIndex ? "playing" : ""}">${id}</span>`
        ).join(" â€º ");
        ui.structureDisplay.innerHTML = `SEQUENCE: ${fullSequence}`;
        
        const [m, b] = Tone.Transport.position.split(":");
        const measureNum = parseInt(m) % 4;
        if (currentChordProgression.length > 0) {
            const currentChord = currentChordProgression[measureNum % currentChordProgression.length];
            const chordName = getChordFromRoman(currentChord, ui.keySelect.value, ui.scaleSelect.value);
            ui.chordDisplay.innerHTML = `CHORD: ${currentChord} (${chordName})`;
            console.log(`Chord display: ${currentChord} (${chordName}) - Measure: ${measureNum}, Position: ${Tone.Transport.position}`);
        } else {
            console.log('No chord progression available');
        }
        
        const beatInMeasure = Math.floor(b);
        ui.leds.forEach((led, idx) => led.classList.toggle("on", idx === beatInMeasure));
    }
    
    // --- EVENT LISTENERS & CONTROLS ---
    function resetAndStart() {
        console.log('Reset and start...');
        console.log('Current UI values:', ui.keySelect.value, ui.scaleSelect.value);

        try {
            if (conductor) {
                conductor.stop(0);
                conductor.dispose();
            }

            Object.values(synths).forEach(synth => {
                if (synth.releaseAll) synth.releaseAll();
                else if (synth.triggerRelease) synth.triggerRelease();
            });

            generatedSections = {};
            sectionHistory = [];
            currentSectionIndex = 0;
            nextSectionLetterCode = 65;

            // Generate chord progression for the current key and scale
            try {
                currentChordProgression = generateChordProgression(ui.keySelect.value, ui.scaleSelect.value);
                console.log('Generated chord progression:', currentChordProgression);
            } catch (error) {
                console.error('Error generating chord progression:', error);
                currentChordProgression = ['I', 'IV', 'V', 'I']; // Fallback
            }

            generatedSections['A'] = generateSectionData();
            generatedSections['B'] = generateSectionData();
            sectionHistory = ['A', 'B'];
            nextSectionLetterCode = 67;
            generateNextSectionInBackground();

            conductor = new Tone.Loop(time => {
                Tone.Draw.schedule(() => {
                    Object.values(synths).forEach(synth => {
                        if (synth.releaseAll) synth.releaseAll(time);
                        else if (synth.triggerRelease) synth.triggerRelease(time);
                    });
                    
                    playSection(time, sectionHistory[currentSectionIndex]);
                    
                    if (currentSectionIndex === sectionHistory.length - 1) {
                        decideNextSection();
                    }
                    currentSectionIndex = (currentSectionIndex + 1) % sectionHistory.length;
                }, time);
            }, SECTION_LENGTH).start(0);

            Tone.Transport.start();
            isPlaying = true;
            ui.statusText.textContent = "PLAYING";
            ui.statusText.style.color = "#00ff00";
            ui.debugDisplay.textContent = "Audio context active - generating music...";
            console.log('Playback started!');
        } catch (error) {
            console.error('Error starting playback:', error);
            ui.statusText.textContent = "ERROR";
            ui.statusText.style.color = "#ff0000";
        }
    }

    ui.playBtn.addEventListener('click', async () => {
        console.log('Play button clicked');
        
        // Ensure audio context is started
        if (Tone.context.state !== 'running') {
            await Tone.start();
        }
        
        if (!audioReady) setupAudio();
        
        if (Tone.Transport.state === 'paused' && isPlaying) {
            Tone.Transport.start();
        } else {
            resetAndStart();
        }
        isPlaying = true;
        ui.statusText.textContent = "PLAYING";
    });

    ui.stopBtn.addEventListener('click', () => {
        console.log('Stop button clicked');
        
        try {
            Tone.Transport.pause();
            isPlaying = false;
            if (audioReady) {
                Object.values(synths).forEach(synth => {
                    if (synth.releaseAll) synth.releaseAll();
                    else if (synth.triggerRelease) synth.triggerRelease();
                });
            }
            
            // Stop all active parts
            Object.values(activeParts).forEach(p => { 
                p.stop(); 
                p.dispose(); 
            });
            activeParts = {};
            
            ui.statusText.textContent = "STOPPED";
            ui.statusText.style.color = "#ff6b6b";
            console.log('Playback stopped');
        } catch (error) {
            console.error('Error stopping playback:', error);
            ui.statusText.textContent = "ERROR";
            ui.statusText.style.color = "#ff0000";
        }
    });

    ui.evolveBtn.addEventListener('click', () => {
        if (!isPlaying) {
            ui.statusText.textContent = "PRESS PLAY FIRST";
            return;
        }
        forceNextNew = true;
        ui.evolveBtn.classList.add('active-force');
        setTimeout(() => ui.evolveBtn.classList.remove('active-force'), 200);
        ui.statusText.textContent = "EVOLVING...";
    });
    
    ui.randomizeBtn.addEventListener('click', () => {
        const genres = Object.keys(musicData);
        ui.genreSelect.value = genres[Math.floor(Math.random() * genres.length)];
        
        const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        ui.keySelect.value = keys[Math.floor(Math.random() * keys.length)];
        
        const scales = ['major', 'minor', 'dorian'];
        ui.scaleSelect.value = scales[Math.floor(Math.random() * scales.length)];
        
        ui.bpmSlider.value = 80 + Math.floor(Math.random() * 140);
        ui.bpmValue.textContent = ui.bpmSlider.value;
        Tone.Transport.bpm.value = ui.bpmSlider.value;
        
        ui.intensitySlider.value = Math.floor(Math.random() * 11);
        ui.intensityValue.textContent = ui.intensitySlider.value;
        
        ui.syncopationSlider.value = Math.floor(Math.random() * 11);
        ui.syncopationValue.textContent = ui.syncopationSlider.value;
        
        ui.reverbSlider.value = Math.floor(Math.random() * 8);
        ui.reverbValue.textContent = (ui.reverbSlider.value / 10).toFixed(1);
        if (audioReady) effects.reverb.wet.value = ui.reverbSlider.value / 10;
        
        ui.delaySlider.value = Math.floor(Math.random() * 6);
        ui.delayValue.textContent = (ui.delaySlider.value / 20).toFixed(1);
        if (audioReady) effects.delay.wet.value = ui.delaySlider.value / 20;
        
        ui.randomizeBtn.classList.add('active-force');
        setTimeout(() => ui.randomizeBtn.classList.remove('active-force'), 200);
        ui.statusText.textContent = "RANDOMIZED!";
        
        if (isPlaying) resetAndStart();
    });
    
    ui.genreSelect.addEventListener('change', () => {
        if (isPlaying) resetAndStart();
    });
    
    ui.keySelect.addEventListener('change', () => {
        if (isPlaying) {
            currentChordProgression = generateChordProgression(ui.keySelect.value, ui.scaleSelect.value);
            resetAndStart();
        }
    });

    ui.scaleSelect.addEventListener('change', () => {
        if (isPlaying) {
            currentChordProgression = generateChordProgression(ui.keySelect.value, ui.scaleSelect.value);
            resetAndStart();
        }
    });

    ui.bpmSlider.addEventListener('input', e => {
        ui.bpmValue.textContent = e.target.value;
        Tone.Transport.bpm.value = e.target.value;
    });
    
    ui.intensitySlider.addEventListener('input', e => {
        ui.intensityValue.textContent = e.target.value;
    });
    
    ui.syncopationSlider.addEventListener('input', e => {
        ui.syncopationValue.textContent = e.target.value;
    });
    
    ui.stereoSlider.addEventListener('input', e => {
        ui.stereoValue.textContent = e.target.value;
    });

    const waveHandler = (e, synthKey) => {
        if (e.target.tagName !== 'BUTTON' || !audioReady) return;
        const wave = e.target.dataset.wave;
        synths[synthKey].set({ oscillator: { type: wave } });
        e.target.parentElement.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        e.target.classList.add("active");
    };
    
    ui.leadWaveBtns.addEventListener('click', e => waveHandler(e, 'lead'));
    ui.bassWaveBtns.addEventListener('click', e => waveHandler(e, 'bass'));

    ui.mixerControls.addEventListener('click', e => {
        if (e.target.tagName !== 'BUTTON') return;
        e.target.classList.toggle('active');
        const track = e.target.dataset.track;
        const isActive = e.target.classList.contains('active');
        if (!audioReady) return;
        const targetPart = activeParts[track];
        if (targetPart) targetPart.mute = !isActive;
    });
    
    ui.mixerControls.querySelectorAll('[data-volume]').forEach(slider => {
        slider.addEventListener('input', e => {
            const track = e.target.dataset.volume;
            const value = parseFloat(e.target.value);
            const label = ui.mixerControls.querySelector(`[data-volume-label="${track}"]`);
            if (label) label.textContent = `${value} dB`;
            
            if (audioReady && synths[track]) {
                synths[track].volume.value = value;
            }
        });
    });

    ui.reverbSlider.addEventListener('input', e => {
        const v = e.target.value / 10;
        ui.reverbValue.textContent = v.toFixed(1);
        if (audioReady) effects.reverb.wet.value = v;
    });
    
    ui.delaySlider.addEventListener('input', e => {
        const v = e.target.value / 20;
        ui.delayValue.textContent = v.toFixed(1);
        if (audioReady) effects.delay.wet.value = v;
    });
    
    ui.filterSlider.addEventListener('input', e => {
        const v = 200 * Math.pow(10, e.target.value / 5);
        ui.filterValue.textContent = e.target.value;
        if (audioReady) effects.filter.frequency.rampTo(v, 0.1);
    });

    new Tone.Loop(time => Tone.Draw.schedule(() => updateVisuals(), time), '16n').start(0);

    function init() {
        Object.keys(musicData).forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            ui.genreSelect.appendChild(option);
        });
        
        const initialGenre = musicData[ui.genreSelect.value];
        ui.bpmSlider.value = initialGenre.bpm;
        ui.bpmValue.textContent = initialGenre.bpm;
        ui.keySelect.value = initialGenre.key;
        ui.scaleSelect.value = initialGenre.scale;
        Tone.Transport.bpm.value = initialGenre.bpm;
        
        console.log('RetroWave Composer Pro Ready!');
        
        // Test audio generation
        testAudioGeneration();
    }
    
    function testAudioGeneration() {
        console.log('Testing audio generation...');
        ui.debugDisplay.textContent = "Testing audio generation...";
        
        const testSection = generateSectionData();
        console.log('Test section generated:', testSection);
        
        // Test if we have valid patterns
        let testResults = [];
        if (testSection.lead && testSection.lead.length > 0) {
            console.log('âœ“ Lead patterns working');
            testResults.push('Lead âœ“');
        }
        if (testSection.bass && testSection.bass.length > 0) {
            console.log('âœ“ Bass patterns working');
            testResults.push('Bass âœ“');
        }
        if (testSection.drums && testSection.drums.length > 0) {
            console.log('âœ“ Drum patterns working');
            testResults.push('Drums âœ“');
        }
        
        ui.debugDisplay.textContent = `Test complete: ${testResults.join(', ')}`;
        console.log('Audio generation test complete!');
    }
    
    // Add global click handler to initialize audio on any user interaction
    document.addEventListener('click', async () => {
        if (Tone.context.state === 'suspended') {
            await Tone.start();
            console.log('Audio context started from user interaction');
        }
    }, { once: true });
    
    // Also start audio on any keypress
    document.addEventListener('keydown', async () => {
        if (Tone.context.state === 'suspended') {
            await Tone.start();
            console.log('Audio context started from keypress');
        }
    }, { once: true });
    
    init();
});
</script>
</body>
</html>