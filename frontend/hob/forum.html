<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Forum - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <!-- Smart navigation will be loaded dynamically -->
    <style>
        :root {
            --primary: #1E3A8A;
            --secondary: #3B82F6;
            --accent: #10B981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0ea5e9;
            --bg-light: #F8FAFC;
            --bg-dark: #0F172A;
            --text-light: #1F2937;
            --text-dark: #F8FAFC;
            --text-muted: #64748B;
            --border: #e2e8f0;
            --font-heading: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        html[data-theme="dark"] {
            --primary: #3B82F6;
            --secondary: #60A5FA;
            --bg-light: #0F172A;
            --bg-dark: #1E293B;
            --text-light: #F8FAFC;
            --text-dark: #1F2937;
            --text-muted: #94A3B8;
            --border: #334155;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        h1, h2, h3, h4 {
            font-family: var(--font-heading);
        }

        .navbar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
        }

        .card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        html[data-theme="dark"] .card {
            background-color: var(--bg-dark);
        }

        .forum-card {
            border-left: 4px solid var(--secondary);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .forum-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }

        .message-sent {
            background-color: var(--secondary);
            color: white;
            margin-left: auto;
        }

        .message-received {
            background-color: var(--border);
            color: var(--text-light);
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            background-color: #10B981;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .offline-indicator {
            width: 8px;
            height: 8px;
            background-color: #6B7280;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .category-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .category-general { background-color: #EFF6FF; color: #2563EB; }
        .category-technical { background-color: #ECFDF5; color: #059669; }
        .category-threats { background-color: #FEF2F2; color: #DC2626; }
        .category-tools { background-color: #FEF3C7; color: #D97706; }
        .category-career { background-color: #F3E8FF; color: #7C3AED; }

        html[data-theme="dark"] .category-general { background-color: #1E3A8A; color: #93C5FD; }
        html[data-theme="dark"] .category-technical { background-color: #064E3B; color: #6EE7B7; }
        html[data-theme="dark"] .category-threats { background-color: #7F1D1D; color: #FCA5A5; }
        html[data-theme="dark"] .category-tools { background-color: #7C2D12; color: #FDBA74; }
        html[data-theme="dark"] .category-career { background-color: #581C87; color: #C4B5FD; }
    </style>
</head>
<body data-theme="dark" class="antialiased">

    <!-- Include Standard Navigation -->
    <div id="navigation-container"></div>

    <main>
        <!-- Hero Section -->
        <section class="relative bg-gray-900 text-white pt-32 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center">
                    <h1 class="text-5xl font-black mb-6">Community Forum</h1>
                    <p class="text-xl text-gray-300 max-w-3xl mx-auto">
                        Connect with cybersecurity professionals, share knowledge, discuss threats, 
                        and collaborate on investigations.
                    </p>
                </div>
            </div>
        </section>


        <!-- Forum Navigation -->
        <section class="py-8 bg-gray-800 dark:bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex flex-wrap gap-4 justify-center">
                    <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-gray-600 transition forum-tab active" data-tab="discussions">
                        <i class="fas fa-comments mr-2"></i>Discussions
                    </button>
                    <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-300 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition forum-tab" data-tab="messages">
                        <i class="fas fa-envelope mr-2"></i>Messages
                    </button>
                    <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-300 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition forum-tab" data-tab="groups">
                        <i class="fas fa-users mr-2"></i>Groups
                    </button>
                    <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-300 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition forum-tab" data-tab="events">
                        <i class="fas fa-calendar mr-2"></i>Events
                    </button>
                </div>
            </div>
        </section>

        <!-- Forum Content -->
        <section class="py-16 bg-gray-900 dark:bg-gray-900">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                    <!-- Main Content -->
                    <div class="lg:col-span-3">
                        <!-- Discussions Tab -->
                        <div id="discussions-tab" class="forum-tab-content">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Recent Discussions</h2>
                                <button onclick="showNewPostModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-plus mr-2"></i>New Post
                                </button>
                            </div>

                            <div id="discussionsList" class="space-y-4">
                                <!-- Discussions will be loaded dynamically -->
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                    <p class="text-gray-500">Loading discussions...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Messages Tab -->
                        <div id="messages-tab" class="forum-tab-content hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Direct Messages</h2>
                                <button onclick="showNewMessageModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-plus mr-2"></i>New Message
                                </button>
                            </div>

                            <div id="messagesList" class="space-y-4">
                                <!-- Messages will be loaded dynamically -->
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                    <p class="text-gray-500">Loading messages...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Groups Tab -->
                        <div id="groups-tab" class="forum-tab-content hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Groups</h2>
                                <button onclick="showCreateGroupModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-plus mr-2"></i>Create Group
                                </button>
                            </div>

                            <div id="groupsList" class="space-y-4">
                                <!-- Groups will be loaded dynamically -->
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                    <p class="text-gray-500">Loading groups...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Events Tab -->
                        <div id="events-tab" class="forum-tab-content hidden">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-2xl font-bold">Events</h2>
                                <button onclick="showCreateEventModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    <i class="fas fa-plus mr-2"></i>Create Event
                                </button>
                            </div>

                            <div id="eventsList" class="space-y-4">
                                <!-- Events will be loaded dynamically -->
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                    <p class="text-gray-500">Loading events...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="lg:col-span-1">
                        <!-- Online Users -->
                        <div class="card p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-users text-green-500"></i> Online Now
                            </h3>
                            <div id="onlineUsers" class="space-y-2">
                                <!-- Online users will be loaded dynamically -->
                                <div class="text-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500 mx-auto mb-2"></div>
                                    <p class="text-sm text-gray-500">Loading...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Categories -->
                        <div class="card p-6 mb-6">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-tags text-blue-500"></i> Categories
                            </h3>
                            <div class="space-y-2">
                                <button onclick="filterByCategory('all')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter active" data-category="all">
                                    <i class="fas fa-globe mr-2"></i>All Discussions
                                </button>
                                <button onclick="filterByCategory('general')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter" data-category="general">
                                    <i class="fas fa-comment mr-2"></i>General
                                </button>
                                <button onclick="filterByCategory('technical')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter" data-category="technical">
                                    <i class="fas fa-code mr-2"></i>Technical
                                </button>
                                <button onclick="filterByCategory('threats')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter" data-category="threats">
                                    <i class="fas fa-shield-alt mr-2"></i>Threats
                                </button>
                                <button onclick="filterByCategory('tools')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter" data-category="tools">
                                    <i class="fas fa-tools mr-2"></i>Tools
                                </button>
                                <button onclick="filterByCategory('career')" class="w-full text-left px-3 py-2 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-700 transition category-filter" data-category="career">
                                    <i class="fas fa-briefcase mr-2"></i>Career
                                </button>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="card p-6">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-clock text-purple-500"></i> Recent Activity
                            </h3>
                            <div id="recentActivity" class="space-y-3">
                                <!-- Recent activity will be loaded dynamically -->
                                <div class="text-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mx-auto mb-2"></div>
                                    <p class="text-sm text-gray-500">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- New Post Modal -->
    <div id="newPostModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-900 dark:bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Create New Post</h3>
                <button onclick="hideNewPostModal()" class="text-gray-400 hover:text-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="createPost(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">Title</label>
                    <input type="text" id="postTitle" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">Category</label>
                    <select id="postCategory" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white">
                        <option value="general">General</option>
                        <option value="technical">Technical</option>
                        <option value="threats">Threats</option>
                        <option value="tools">Tools</option>
                        <option value="career">Career</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">Content</label>
                    <textarea id="postContent" required rows="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-gray-600 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Post
                    </button>
                    <button type="button" onclick="hideNewPostModal()" class="px-4 py-2 bg-gray-8000 text-white rounded-md hover:bg-gray-600 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-900 dark:bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Send Message</h3>
                <button onclick="hideNewMessageModal()" class="text-gray-400 hover:text-gray-400">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="sendMessage(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">To</label>
                    <select id="messageTo" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white">
                        <option value="">Select user...</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">Subject</label>
                    <input type="text" id="messageSubject" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 dark:text-gray-300 mb-2">Message</label>
                    <textarea id="messageContent" required rows="6" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-700 text-white dark:text-white"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-gray-600 transition">
                        <i class="fas fa-paper-plane mr-2"></i>Send
                    </button>
                    <button type="button" onclick="hideNewMessageModal()" class="px-4 py-2 bg-gray-8000 text-white rounded-md hover:bg-gray-600 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://project-revelare-backend.liberatorgeminorum.workers.dev';
        
        let currentTab = 'discussions';
        let currentCategory = 'all';

        // Tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.forum-tab');
            const tabContents = document.querySelectorAll('.forum-tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Update tab appearance
                    tabs.forEach(t => {
                        t.classList.remove('bg-blue-500', 'text-white');
                        t.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-300', 'dark:text-gray-300');
                    });
                    this.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-300', 'dark:text-gray-300');
                    this.classList.add('bg-blue-500', 'text-white');

                    // Show/hide content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab + '-tab').classList.remove('hidden');
                    
                    currentTab = targetTab;
                    loadTabContent();
                });
            });

            // Load initial content
            loadTabContent();
        });

        async function loadTabContent() {
            switch(currentTab) {
                case 'discussions':
                    await loadDiscussions();
                    break;
                case 'messages':
                    await loadMessages();
                    break;
                case 'groups':
                    await loadGroups();
                    break;
                case 'events':
                    await loadEvents();
                    break;
            }
        }

        async function loadDiscussions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/posts?category=${currentCategory}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load discussions');
                }
                
                const data = await response.json();
                const container = document.getElementById('discussionsList');
                
                if (data.posts && data.posts.length > 0) {
                    container.innerHTML = data.posts.map(post => `
                        <div class="card forum-card p-6">
                            <!-- Post Preview -->
                            <div id="post-${post.id}-preview" class="post-preview">
                                <div class="flex items-start space-x-4">
                                    <div class="category-icon category-${post.category}">
                                        <i class="fas fa-${getCategoryIcon(post.category)}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-2">
                                            <h3 class="text-lg font-semibold flex items-center gap-2">
                                                ${post.pinned ? '<i class="fas fa-thumbtack text-yellow-500" title="Pinned Post"></i>' : ''}
                                                <a href="#" onclick="togglePost(${post.id})" class="hover:text-blue-500 transition">${post.title}</a>
                                            </h3>
                                            <span class="text-sm text-gray-500">${formatTimeAgo(post.created_at)}</span>
                                        </div>
                                        <p class="text-gray-400 dark:text-gray-300 mb-3">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</p>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-4">
                                                <div class="flex items-center">
                                                    <div class="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center mr-2">
                                                        <i class="fas fa-user text-gray-400 dark:text-gray-400"></i>
                                                    </div>
                                                    <span class="text-sm font-medium">${post.author_name}</span>
                                                </div>
                                                <span class="text-sm text-gray-500">${post.reply_count || 0} replies</span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <span class="px-2 py-1 bg-${getCategoryColor(post.category)}-100 dark:bg-${getCategoryColor(post.category)}-900 text-${getCategoryColor(post.category)}-800 dark:text-${getCategoryColor(post.category)}-200 text-xs rounded">${post.category}</span>
                                                <button onclick="togglePost(${post.id})" class="text-blue-500 hover:text-blue-600 text-sm">
                                                    <i class="fas fa-eye mr-1"></i>View Details
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Full Post Content (Hidden by default) -->
                            <div id="post-${post.id}-full" class="post-full hidden">
                                <div class="border-t pt-4 mt-4">
                                    <div class="prose dark:prose-invert max-w-none">
                                        <h3 class="text-xl font-semibold mb-4">${post.title}</h3>
                                        <div class="text-gray-400 dark:text-gray-300 whitespace-pre-wrap">${post.content}</div>
                                    </div>
                                    
                                    <!-- Reply Section -->
                                    <div id="post-${post.id}-replies" class="mt-6 hidden">
                                        <h4 class="text-lg font-semibold mb-4">Replies</h4>
                                        <div id="replies-${post.id}" class="space-y-3 mb-4">
                                            <!-- Replies will be loaded here -->
                                        </div>
                                        
                                        <!-- Reply Form -->
                                        <div class="border-t pt-4">
                                            <button onclick="toggleReplyForm(${post.id})" class="text-blue-500 hover:text-blue-600 mb-3">
                                                <i class="fas fa-reply mr-1"></i>Reply to this post
                                            </button>
                                            
                                            <form id="reply-form-${post.id}" class="hidden" onsubmit="submitReply(event, ${post.id})">
                                                <textarea id="reply-content-${post.id}" 
                                                          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-900 dark:bg-gray-800 text-white dark:text-gray-100 mb-3" 
                                                          rows="4" 
                                                          placeholder="Write your reply..." 
                                                          required></textarea>
                                                <div class="flex justify-end space-x-2">
                                                    <button type="button" onclick="toggleReplyForm(${post.id})" 
                                                            class="px-4 py-2 text-gray-400 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                                                        Cancel
                                                    </button>
                                                    <button type="submit" 
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-gray-600 transition">
                                                        Post Reply
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <!-- Post Actions -->
                                    <div class="flex items-center justify-between mt-4 pt-4 border-t">
                                        <div class="flex items-center space-x-4">
                                            <button onclick="togglePost(${post.id})" class="text-gray-500 hover:text-gray-300 dark:hover:text-gray-300">
                                                <i class="fas fa-compress-alt mr-1"></i>Collapse
                                            </button>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="reportPost(${post.id})" class="text-red-500 hover:text-red-600 text-sm">
                                                <i class="fas fa-flag mr-1"></i>Report
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-comments text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500">No discussions found. Be the first to start a conversation!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading discussions:', error);
                document.getElementById('discussionsList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-red-500">Failed to load discussions. Please try again later.</p>
                    </div>
                `;
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/messages`);
                
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                
                const data = await response.json();
                const container = document.getElementById('messagesList');
                
                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = data.messages.map(message => `
                        <div class="card p-4 cursor-pointer hover:bg-gray-800 dark:hover:bg-gray-800 transition" onclick="openMessage(${message.id})">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gray-300 dark:bg-gray-600 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-gray-400 dark:text-gray-400"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-medium">${message.sender_name}</h4>
                                        <p class="text-sm text-gray-500">${message.subject}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm text-gray-500">${formatTimeAgo(message.created_at)}</span>
                                    ${message.unread ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-1"></div>' : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-envelope text-gray-400 text-4xl mb-4"></i>
                            <p class="text-gray-500">No messages yet. Start a conversation!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <p class="text-red-500">Failed to load messages. Please try again later.</p>
                    </div>
                `;
            }
        }

        async function loadGroups() {
            // Placeholder for groups functionality
            document.getElementById('groupsList').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">Groups feature coming soon!</p>
                </div>
            `;
        }

        async function loadEvents() {
            // Placeholder for events functionality
            document.getElementById('eventsList').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-calendar text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">Events feature coming soon!</p>
                </div>
            `;
        }

        function filterByCategory(category) {
            currentCategory = category;
            
            // Update category filter appearance
            document.querySelectorAll('.category-filter').forEach(filter => {
                filter.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-200');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-200');
            
            if (currentTab === 'discussions') {
                loadDiscussions();
            }
        }

        function getCategoryIcon(category) {
            const icons = {
                general: 'comment',
                technical: 'code',
                threats: 'shield-alt',
                tools: 'tools',
                career: 'briefcase'
            };
            return icons[category] || 'comment';
        }

        function getCategoryColor(category) {
            const colors = {
                general: 'blue',
                technical: 'green',
                threats: 'red',
                tools: 'yellow',
                career: 'purple'
            };
            return colors[category] || 'blue';
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        // Modal functions
        function showNewPostModal() {
            document.getElementById('newPostModal').classList.remove('hidden');
        }

        function hideNewPostModal() {
            document.getElementById('newPostModal').classList.add('hidden');
        }

        function showNewMessageModal() {
            document.getElementById('newMessageModal').classList.remove('hidden');
        }

        function hideNewMessageModal() {
            document.getElementById('newMessageModal').classList.add('hidden');
        }

        function showCreateGroupModal() {
            alert('Create group functionality coming soon!');
        }

        function showCreateEventModal() {
            alert('Create event functionality coming soon!');
        }

        async function createPost(event) {
            event.preventDefault();
            
            const title = document.getElementById('postTitle').value;
            const category = document.getElementById('postCategory').value;
            const content = document.getElementById('postContent').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ title, category, content })
                });
                
                if (response.ok) {
                    hideNewPostModal();
                    loadDiscussions();
                    // Reset form
                    document.getElementById('postTitle').value = '';
                    document.getElementById('postContent').value = '';
                } else {
                    alert('You must be logged in to create posts. Please login or register first.');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                alert('You must be logged in to create posts. Please login or register first.');
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            
            const to = document.getElementById('messageTo').value;
            const subject = document.getElementById('messageSubject').value;
            const content = document.getElementById('messageContent').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ to, subject, content })
                });
                
                if (response.ok) {
                    hideNewMessageModal();
                    loadMessages();
                    // Reset form
                    document.getElementById('messageTo').value = '';
                    document.getElementById('messageSubject').value = '';
                    document.getElementById('messageContent').value = '';
                } else {
                    alert('Failed to send message. Please try again.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message. Please try again.');
            }
        }

        // Forum functionality functions
        function togglePost(postId) {
            const preview = document.getElementById(`post-${postId}-preview`);
            const full = document.getElementById(`post-${postId}-full`);
            const replies = document.getElementById(`post-${postId}-replies`);
            
            if (full.classList.contains('hidden')) {
                // Show full post and load replies
                preview.classList.add('hidden');
                full.classList.remove('hidden');
                replies.classList.remove('hidden');
                loadReplies(postId);
            } else {
                // Hide full post
                preview.classList.remove('hidden');
                full.classList.add('hidden');
                replies.classList.add('hidden');
            }
        }

        async function loadReplies(postId) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/posts/${postId}/replies`);
                const data = await response.json();
                
                const container = document.getElementById(`replies-${postId}`);
                
                if (data.replies && data.replies.length > 0) {
                    container.innerHTML = data.replies.map(reply => `
                        <div class="bg-gray-800 p-3 rounded-md">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-400">${reply.author_name}</span>
                                <span class="text-xs text-gray-500">${formatTimeAgo(reply.created_at)}</span>
                            </div>
                            <p class="text-gray-300 text-sm">${reply.content}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No replies yet.</p>';
                }
            } catch (error) {
                console.error('Error loading replies:', error);
                document.getElementById(`replies-${postId}`).innerHTML = '<p class="text-red-500 text-sm">Failed to load replies.</p>';
            }
        }

        function toggleReplyForm(postId) {
            const form = document.getElementById(`reply-form-${postId}`);
            form.classList.toggle('hidden');
        }

        async function submitReply(event, postId) {
            event.preventDefault();
            
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('You must be logged in to reply to posts.');
                return;
            }
            
            const content = document.getElementById(`reply-content-${postId}`).value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/posts/${postId}/replies`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ content })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById(`reply-content-${postId}`).value = '';
                    toggleReplyForm(postId);
                    loadReplies(postId);
                    loadDiscussions(); // Refresh to update reply count
                } else {
                    alert('Failed to post reply. Please try again.');
                }
            } catch (error) {
                console.error('Error posting reply:', error);
                alert('Failed to post reply. Please try again.');
            }
        }

        function reportPost(postId) {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                alert('You must be logged in to report posts.');
                return;
            }
            
            const reason = prompt('Please select a reason for reporting this post:\n1. Spam\n2. Inappropriate content\n3. Harassment\n4. Off-topic\n5. Other\n\nEnter the number (1-5):');
            
            if (!reason || reason < 1 || reason > 5) {
                return;
            }
            
            const reasons = ['', 'Spam', 'Inappropriate content', 'Harassment', 'Off-topic', 'Other'];
            const description = prompt('Please provide additional details (optional):');
            
            fetch(`${API_BASE_URL}/api/forum/posts/${postId}/report`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    reason: reasons[reason],
                    description: description || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Report submitted successfully. Thank you for helping maintain our community.');
                } else {
                    alert('Failed to submit report. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error submitting report:', error);
                alert('Failed to submit report. Please try again.');
            });
        }

        async function loadOnlineUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/forum/online`);
                const data = await response.json();
                
                const container = document.getElementById('onlineUsers');
                
                if (data.users && data.users.length > 0) {
                    container.innerHTML = data.users.map(user => `
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-green-400">${user.name}</span>
                            <span class="text-gray-500">${formatTimeAgo(user.last_seen)}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">No users currently online.</p>';
                }
            } catch (error) {
                console.error('Error loading online users:', error);
                document.getElementById('onlineUsers').innerHTML = '<p class="text-red-500 text-sm">Failed to load online users.</p>';
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function getCategoryColor(category) {
            const colors = {
                'general': 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
                'technical': 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
                'threats': 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
                'tools': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
                'career': 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200'
            };
            return colors[category] || 'bg-gray-700 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
        }

        function openMessage(messageId) {
            alert(`Open message ${messageId} - detailed view coming soon!`);
        }
        
        // Load online users on page load and refresh every 30 seconds
        document.addEventListener('DOMContentLoaded', function() {
            loadOnlineUsers();
            setInterval(loadOnlineUsers, 30000);
        });
    </script>

</body>
</html>

