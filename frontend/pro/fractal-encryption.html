<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Encryption - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <!-- Upgrade Redirect Script -->
    <script src="/js/upgrade-redirect.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #1E293B;
            border-top: 4px solid #3B82F6;
        }
        .encryption-card {
            background-color: #1E293B;
            border-left: 4px solid #8B5CF6;
            transition: all 0.3s ease;
        }
        .encryption-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .fractal-canvas {
            border: 2px solid #374151;
            border-radius: 0.5rem;
            background-color: #111827;
        }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #8B5CF6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #374151;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #3B82F6);
            transition: width 0.3s ease;
        }
        .ifs-editor {
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }
        .transform-input {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            color: #F8FAFC;
            padding: 0.5rem;
            border-radius: 0.25rem;
            width: 80px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <main class="pt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Fractal Encryption</h1>
                <p class="text-gray-400">Encode any file into the structure and color of an Iterated Function System (IFS) fractal</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Controls -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-snowflake text-purple-500"></i> Controls
                    </h2>
                    
                    <!-- File Selection -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">1. Select Input File</label>
                        <div class="file-upload-area" id="file-upload-area">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-400">Click to select a file...</p>
                            <input type="file" id="fileInput" class="hidden">
                        </div>
                        <div id="fileInfo" class="hidden mt-2 p-2 bg-gray-800 rounded text-sm text-gray-300"></div>
                    </div>

                    <!-- Encryption Key -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">2. Encryption Key (IFS Coefficients)</label>
                        <div class="flex flex-wrap gap-2 mb-2">
                            <button id="generateKeyBtn" class="btn btn-sm btn-primary">Generate Random</button>
                            <button id="importKeyBtn" class="btn btn-sm btn-outline">Import Key</button>
                            <button id="exportKeyBtn" class="btn btn-sm btn-outline">Export Key</button>
                            <button id="resetKeyBtn" class="btn btn-sm btn-outline">Reset Default</button>
                        </div>
                        <div id="ifs-editor" class="ifs-editor">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-400">Transform 1</label>
                                    <div class="flex gap-1 mt-1">
                                        <input type="number" class="transform-input" id="t1a" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t1b" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t1c" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t1d" step="0.01" value="0.16">
                                        <input type="number" class="transform-input" id="t1e" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t1f" step="0.01" value="0.00">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Transform 2</label>
                                    <div class="flex gap-1 mt-1">
                                        <input type="number" class="transform-input" id="t2a" step="0.01" value="0.85">
                                        <input type="number" class="transform-input" id="t2b" step="0.01" value="0.04">
                                        <input type="number" class="transform-input" id="t2c" step="0.01" value="-0.04">
                                        <input type="number" class="transform-input" id="t2d" step="0.01" value="0.85">
                                        <input type="number" class="transform-input" id="t2e" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t2f" step="0.01" value="1.60">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Transform 3</label>
                                    <div class="flex gap-1 mt-1">
                                        <input type="number" class="transform-input" id="t3a" step="0.01" value="0.20">
                                        <input type="number" class="transform-input" id="t3b" step="0.01" value="-0.26">
                                        <input type="number" class="transform-input" id="t3c" step="0.01" value="0.23">
                                        <input type="number" class="transform-input" id="t3d" step="0.01" value="0.22">
                                        <input type="number" class="transform-input" id="t3e" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t3f" step="0.01" value="1.60">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400">Transform 4</label>
                                    <div class="flex gap-1 mt-1">
                                        <input type="number" class="transform-input" id="t4a" step="0.01" value="-0.15">
                                        <input type="number" class="transform-input" id="t4b" step="0.01" value="0.28">
                                        <input type="number" class="transform-input" id="t4c" step="0.01" value="0.26">
                                        <input type="number" class="transform-input" id="t4d" step="0.01" value="0.24">
                                        <input type="number" class="transform-input" id="t4e" step="0.01" value="0.00">
                                        <input type="number" class="transform-input" id="t4f" step="0.01" value="0.44">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Encryption Settings -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">3. Enhanced Security Settings</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Encryption Password</label>
                                <input type="password" id="encryptionPassword" placeholder="Enter encryption password" 
                                       class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Encryption Layers (1-10)</label>
                                <input type="number" id="encryptionLayers" min="1" max="10" value="3" 
                                       class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="bg-purple-900/20 p-3 rounded-md border border-purple-500/30">
                                <p class="text-xs text-purple-300">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    <strong>Multi-Layer Security:</strong> AES-256-GCM, ChaCha20-Poly1305, Fernet, XOR-Custom, Base64
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-group mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">4. Actions</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="encryptBtn" class="btn btn-primary">
                                <i class="fas fa-lock"></i> Encrypt & Draw
                            </button>
                            <button id="decryptBtn" class="btn btn-success">
                                <i class="fas fa-unlock"></i> Decrypt Canvas
                            </button>
                            <button id="downloadPNGBtn" class="btn btn-outline">
                                <i class="fas fa-image"></i> Download PNG
                            </button>
                            <button id="loadImageBtn" class="btn btn-outline">
                                <i class="fas fa-upload"></i> Decrypt from PNG
                            </button>
                        </div>
                        <input type="file" id="loadImageInput" class="hidden" accept=".png">
                    </div>

                    <!-- Progress -->
                    <div id="progress-container" class="hidden">
                        <div id="status" class="text-sm text-gray-300 text-center mb-2"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <button id="cancelBtn" class="btn btn-danger w-full mt-2">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>

                <!-- Fractal Canvas -->
                <div class="encryption-card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-palette text-purple-500"></i> Fractal Canvas
                    </h2>
                    <div class="text-center">
                        <canvas id="fractalCanvas" class="fractal-canvas" width="400" height="400"></canvas>
                        <div id="canvasInfo" class="mt-4 text-sm text-gray-400">
                            <p>Select a file and click "Encrypt & Draw" to generate a fractal</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Security Dashboard -->
            <div class="card p-6 rounded-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-shield-alt text-green-500"></i> File Security Dashboard
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-gray-600 p-3 rounded text-center">
                        <div class="text-2xl font-bold" id="encryptedFilesCount">0</div>
                        <div class="text-sm">Encrypted Files</div>
                    </div>
                    <div class="bg-gray-600 p-3 rounded text-center">
                        <div class="text-2xl font-bold" id="totalSecurityScore">0</div>
                        <div class="text-sm">Security Score</div>
                    </div>
                    <div class="bg-gray-600 p-3 rounded text-center">
                        <div class="text-2xl font-bold" id="activeKeys">0</div>
                        <div class="text-sm">Active Keys</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="bulkEncryptBtn" class="btn btn-primary">
                        <i class="fas fa-lock"></i> Bulk Encrypt Case Files
                    </button>
                    <button id="securityAuditBtn" class="btn btn-outline">
                        <i class="fas fa-search"></i> Security Audit
                    </button>
                    <button id="keyRotationBtn" class="btn btn-warning">
                        <i class="fas fa-sync"></i> Rotate Keys
                    </button>
                </div>
            </div>

            <!-- Multi-Layer Encryption Settings -->
            <div class="card p-6 rounded-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-layer-group text-blue-500"></i> Multi-Layer Encryption
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Encryption Layers</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="fractalLayer" class="mr-2" checked>
                                <span class="text-gray-300">Fractal Encryption (Primary)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="aesLayer" class="mr-2" checked>
                                <span class="text-gray-300">AES-256 (Secondary)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="rsaLayer" class="mr-2">
                                <span class="text-gray-300">RSA-2048 (Tertiary)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="customLayer" class="mr-2">
                                <span class="text-gray-300">Custom Algorithm</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Security Level</label>
                        <select id="securityLevel" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600">
                            <option value="standard">Standard (2 layers)</option>
                            <option value="high">High (3 layers)</option>
                            <option value="maximum">Maximum (4 layers)</option>
                        </select>
                        <p class="text-sm text-gray-400 mt-1">Higher levels provide more security but slower processing</p>
                    </div>
                </div>
            </div>

            <!-- File Selection for Cases -->
            <div class="card p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-folder-open text-blue-500"></i> Encrypt Case Files
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Select Case</label>
                        <select id="caseSelect" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600">
                            <option value="">Choose a case...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Select File</label>
                        <select id="fileSelect" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" disabled>
                            <option value="">Choose a file...</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="encryptCaseFileBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-lock"></i> Encrypt Case File
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://project-revelare-backend.liberatorgeminorum.workers.dev';
        
        let currentCases = [];
        let currentFile = null;
        let encryptedPoints = null;
        let canvas = null;
        let ctx = null;
        let securityStats = {
            encryptedFiles: 0,
            securityScore: 0,
            activeKeys: 1
        };

        // Load navigation component
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navigation.html');
                const html = await response.text();
                document.getElementById('navigation-container').innerHTML = html;
                
                // Load navigation JavaScript after component is loaded
                const script = document.createElement('script');
                script.src = '/js/navigation.js';
                document.head.appendChild(script);
                
                // Initialize canvas
                canvas = document.getElementById('fractalCanvas');
                ctx = canvas.getContext('2d');
                
                // Load cases after navigation is ready
                setTimeout(loadCases, 1000);
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize security dashboard
                updateSecurityDashboard();
            } catch (error) {
                console.error('Failed to load navigation:', error);
            }
        });

        function setupEventListeners() {
            // File upload
            document.getElementById('file-upload-area').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Key management
            document.getElementById('generateKeyBtn').addEventListener('click', generateRandomKey);
            document.getElementById('importKeyBtn').addEventListener('click', importKey);
            document.getElementById('exportKeyBtn').addEventListener('click', exportKey);
            document.getElementById('resetKeyBtn').addEventListener('click', resetDefaultKey);

            // Actions
            document.getElementById('encryptBtn').addEventListener('click', encryptFile);
            document.getElementById('decryptBtn').addEventListener('click', decryptCanvas);
            document.getElementById('downloadPNGBtn').addEventListener('click', downloadPNG);
            document.getElementById('loadImageBtn').addEventListener('click', () => {
                document.getElementById('loadImageInput').click();
            });
            document.getElementById('loadImageInput').addEventListener('change', loadImageForDecryption);

            // Case file encryption
            document.getElementById('caseSelect').addEventListener('change', loadCaseFiles);
            document.getElementById('fileSelect').addEventListener('change', () => {
                document.getElementById('encryptCaseFileBtn').disabled = !document.getElementById('fileSelect').value;
            });
            document.getElementById('encryptCaseFileBtn').addEventListener('click', encryptCaseFile);
            
            // New security features
            document.getElementById('bulkEncryptBtn').addEventListener('click', bulkEncryptFiles);
            document.getElementById('securityAuditBtn').addEventListener('click', performSecurityAudit);
            document.getElementById('keyRotationBtn').addEventListener('click', rotateEncryptionKeys);
            
            // Security level change
            document.getElementById('securityLevel').addEventListener('change', updateSecuritySettings);
        }

        // Load user's cases
        async function loadCases() {
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentCases = data.cases || [];
                    populateCaseSelect();
                } else {
                    throw new Error('Failed to load cases');
                }
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('caseSelect').innerHTML = '<option value="">Error loading cases</option>';
            }
        }

        function populateCaseSelect() {
            const select = document.getElementById('caseSelect');
            select.innerHTML = '<option value="">Choose a case...</option>';
            
            currentCases.forEach(case => {
                const option = document.createElement('option');
                option.value = case.id;
                option.textContent = `${case.name} (${case.files.length} files)`;
                select.appendChild(option);
            });
        }

        async function loadCaseFiles() {
            const caseId = document.getElementById('caseSelect').value;
            const fileSelect = document.getElementById('fileSelect');
            
            if (!caseId) {
                fileSelect.innerHTML = '<option value="">Choose a file...</option>';
                fileSelect.disabled = true;
                document.getElementById('encryptCaseFileBtn').disabled = true;
                return;
            }

            const caseData = currentCases.find(c => c.id === caseId);
            if (!caseData) return;

            fileSelect.innerHTML = '<option value="">Choose a file...</option>';
            caseData.files.forEach(file => {
                const option = document.createElement('option');
                option.value = file.id;
                option.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileSelect.appendChild(option);
            });
            
            fileSelect.disabled = false;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                document.getElementById('fileInfo').innerHTML = `
                    <strong>${file.name}</strong><br>
                    Size: ${(file.size / 1024).toFixed(1)} KB<br>
                    Type: ${file.type || 'Unknown'}
                `;
                document.getElementById('fileInfo').classList.remove('hidden');
            }
        }

        function generateRandomKey() {
            const transforms = ['t1', 't2', 't3', 't4'];
            transforms.forEach(transform => {
                document.getElementById(`${transform}a`).value = (Math.random() * 2 - 1).toFixed(2);
                document.getElementById(`${transform}b`).value = (Math.random() * 2 - 1).toFixed(2);
                document.getElementById(`${transform}c`).value = (Math.random() * 2 - 1).toFixed(2);
                document.getElementById(`${transform}d`).value = (Math.random() * 2 - 1).toFixed(2);
                document.getElementById(`${transform}e`).value = (Math.random() * 2 - 1).toFixed(2);
                document.getElementById(`${transform}f`).value = (Math.random() * 2 - 1).toFixed(2);
            });
        }

        function resetDefaultKey() {
            const defaults = {
                t1: [0.00, 0.00, 0.00, 0.16, 0.00, 0.00],
                t2: [0.85, 0.04, -0.04, 0.85, 0.00, 1.60],
                t3: [0.20, -0.26, 0.23, 0.22, 0.00, 1.60],
                t4: [-0.15, 0.28, 0.26, 0.24, 0.00, 0.44]
            };

            Object.entries(defaults).forEach(([transform, values]) => {
                ['a', 'b', 'c', 'd', 'e', 'f'].forEach((param, index) => {
                    document.getElementById(`${transform}${param}`).value = values[index].toFixed(2);
                });
            });
        }

        function exportKey() {
            const key = getCurrentKey();
            const blob = new Blob([JSON.stringify(key, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fractal-key.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importKey() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const key = JSON.parse(e.target.result);
                            setCurrentKey(key);
                        } catch (error) {
                            alert('Invalid key file');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function getCurrentKey() {
            const transforms = ['t1', 't2', 't3', 't4'];
            return transforms.map(transform => ({
                a: parseFloat(document.getElementById(`${transform}a`).value),
                b: parseFloat(document.getElementById(`${transform}b`).value),
                c: parseFloat(document.getElementById(`${transform}c`).value),
                d: parseFloat(document.getElementById(`${transform}d`).value),
                e: parseFloat(document.getElementById(`${transform}e`).value),
                f: parseFloat(document.getElementById(`${transform}f`).value)
            }));
        }

        function setCurrentKey(key) {
            const transforms = ['t1', 't2', 't3', 't4'];
            transforms.forEach((transform, index) => {
                if (key[index]) {
                    document.getElementById(`${transform}a`).value = key[index].a.toFixed(2);
                    document.getElementById(`${transform}b`).value = key[index].b.toFixed(2);
                    document.getElementById(`${transform}c`).value = key[index].c.toFixed(2);
                    document.getElementById(`${transform}d`).value = key[index].d.toFixed(2);
                    document.getElementById(`${transform}e`).value = key[index].e.toFixed(2);
                    document.getElementById(`${transform}f`).value = key[index].f.toFixed(2);
                }
            });
        }

        async function encryptFile() {
            if (!currentFile) {
                alert('Please select a file first');
                return;
            }

            try {
                showProgress('Encrypting file with enhanced security...');
                
                const password = document.getElementById('encryptionPassword').value || 'default';
                const layers = parseInt(document.getElementById('encryptionLayers').value) || 3;
                
                const arrayBuffer = await currentFile.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // Use enhanced encryption API
                const response = await fetch('/api/cases/demo/files/demo/encrypt', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password,
                        layers: layers
                    })
                });

                if (!response.ok) {
                    throw new Error('Encryption failed');
                }

                const result = await response.json();
                encryptedInfo = result.encryptedInfo;
                
                // Draw fractal with enhanced visualization
                drawEnhancedFractal(encryptedInfo);
                
                document.getElementById('canvasInfo').innerHTML = `
                    <p class="text-green-400">File encrypted with ${layers} layers!</p>
                    <p class="text-sm">Methods: ${result.methods.join(', ')}</p>
                    <p class="text-sm">Original: ${result.originalSize} bytes</p>
                    <p class="text-sm">Points: ${encryptedInfo.points.length}</p>
                `;
                
                hideProgress();
            } catch (error) {
                console.error('Encryption error:', error);
                alert('Encryption failed: ' + error.message);
                hideProgress();
            }
        }

        async function encryptCaseFile() {
            const caseId = document.getElementById('caseSelect').value;
            const fileId = document.getElementById('fileSelect').value;
            
            if (!caseId || !fileId) {
                alert('Please select a case and file');
                return;
            }

            try {
                showProgress('Encrypting case file...');
                
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases/${caseId}/files/${fileId}/encrypt`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    encryptedPoints = data.encryptedPoints;
                    
                    // Draw fractal
                    drawFractal(encryptedPoints);
                    
                    document.getElementById('canvasInfo').innerHTML = `
                        <p class="text-green-400">Case file encrypted successfully!</p>
                        <p class="text-sm">Points: ${encryptedPoints.length}</p>
                        <p class="text-sm">Original size: ${(data.originalSize / 1024).toFixed(1)} KB</p>
                    `;
                } else {
                    throw new Error('Encryption failed');
                }
                
                hideProgress();
            } catch (error) {
                console.error('Case file encryption error:', error);
                alert('Encryption failed');
                hideProgress();
            }
        }

        async function simulateEncryption(data) {
            // Simulate encryption process with progress updates
            const points = [];
            const chunkSize = Math.max(1, Math.floor(data.length / 100));
            
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                
                // Simulate fractal point generation
                for (let j = 0; j < chunk.length; j++) {
                    const byte = chunk[j];
                    points.push({
                        x: Math.random() * 2 - 1,
                        y: Math.random() * 2 - 1,
                        r: byte,
                        g: (byte + 128) % 256,
                        b: (byte + 64) % 256
                    });
                }
                
                // Update progress
                const progress = Math.min(100, ((i + chunkSize) / data.length) * 100);
                updateProgress(progress);
                
                // Simulate processing time
                await new Promise(resolve => setTimeout(resolve, 10));
            }
            
            return points;
        }

        function drawFractal(points) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scale points to canvas
            const scale = Math.min(canvas.width, canvas.height) * 0.4;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            points.forEach(point => {
                const x = centerX + point.x * scale;
                const y = centerY + point.y * scale;
                
                ctx.fillStyle = `rgb(${point.r}, ${point.g}, ${point.b})`;
                ctx.fillRect(x, y, 1, 1);
            });
        }

        function drawEnhancedFractal(encryptedInfo) {
            const canvas = document.getElementById('fractalCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const points = encryptedInfo.points;
            const layers = encryptedInfo.encryption_layers;
            
            // Scale points to canvas
            const scale = Math.min(canvas.width, canvas.height) * 0.4;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw fractal points with layer-based coloring
            points.forEach((point, index) => {
                const x = centerX + point.x * scale;
                const y = centerY + point.y * scale;
                
                // Color based on encryption layer
                const layerIndex = index % layers.length;
                const layer = layers[layerIndex];
                
                let color;
                switch(layer.method) {
                    case 'AES-256-GCM':
                        color = `rgb(${point.r}, ${point.g}, ${point.b})`;
                        break;
                    case 'ChaCha20-Poly1305':
                        color = `rgb(${point.b}, ${point.r}, ${point.g})`;
                        break;
                    case 'Fernet':
                        color = `rgb(${point.g}, ${point.b}, ${point.r})`;
                        break;
                    case 'XOR-Custom':
                        color = `rgb(${Math.max(0, point.r - 50)}, ${Math.max(0, point.g - 50)}, ${Math.max(0, point.b - 50)})`;
                        break;
                    case 'Base64':
                        color = `rgb(${Math.min(255, point.r + 50)}, ${Math.min(255, point.g + 50)}, ${Math.min(255, point.b + 50)})`;
                        break;
                    default:
                        color = `rgb(${point.r}, ${point.g}, ${point.b})`;
                }
                
                ctx.fillStyle = color;
                ctx.fillRect(x, y, 1, 1);
            });
            
            // Add layer legend
            drawLayerLegend(ctx, layers);
        }

        function drawLayerLegend(ctx, layers) {
            const legendX = 10;
            const legendY = 10;
            const legendWidth = 200;
            const legendHeight = layers.length * 25 + 10;
            
            // Background
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(legendX, legendY, legendWidth, legendHeight);
            
            // Border
            ctx.strokeStyle = '#8B5CF6';
            ctx.lineWidth = 2;
            ctx.strokeRect(legendX, legendY, legendWidth, legendHeight);
            
            // Title
            ctx.fillStyle = '#8B5CF6';
            ctx.font = 'bold 12px Inter';
            ctx.fillText('Encryption Layers', legendX + 5, legendY + 15);
            
            // Layer info
            layers.forEach((layer, index) => {
                const y = legendY + 30 + (index * 20);
                
                // Color indicator
                ctx.fillStyle = getLayerColor(layer.method);
                ctx.fillRect(legendX + 5, y - 5, 10, 10);
                
                // Method name
                ctx.fillStyle = '#F8FAFC';
                ctx.font = '10px Inter';
                ctx.fillText(`${layer.layer}. ${layer.method}`, legendX + 20, y + 2);
            });
        }

        function getLayerColor(method) {
            switch(method) {
                case 'AES-256-GCM': return '#3B82F6';
                case 'ChaCha20-Poly1305': return '#10B981';
                case 'Fernet': return '#F59E0B';
                case 'XOR-Custom': return '#EF4444';
                case 'Base64': return '#8B5CF6';
                default: return '#6B7280';
            }
        }

        function decryptCanvas() {
            if (!encryptedPoints) {
                alert('No encrypted data to decrypt');
                return;
            }
            
            // Simulate decryption
            const decryptedData = new Uint8Array(encryptedPoints.length);
            encryptedPoints.forEach((point, index) => {
                decryptedData[index] = point.r;
            });
            
            // Create download
            const blob = new Blob([decryptedData]);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'decrypted_file.bin';
            a.click();
            URL.revokeObjectURL(url);
        }

        function downloadPNG() {
            if (!encryptedPoints) {
                alert('No fractal to download');
                return;
            }
            
            const link = document.createElement('a');
            link.download = 'fractal_encryption.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function loadImageForDecryption(event) {
            const file = event.target.files[0];
            if (file) {
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Extract points from image (simplified)
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const points = [];
                    
                    for (let i = 0; i < imageData.data.length; i += 4) {
                        const r = imageData.data[i];
                        const g = imageData.data[i + 1];
                        const b = imageData.data[i + 2];
                        
                        if (r > 0 || g > 0 || b > 0) {
                            const x = (i / 4) % canvas.width;
                            const y = Math.floor((i / 4) / canvas.width);
                            
                            points.push({
                                x: (x - canvas.width / 2) / (canvas.width * 0.4),
                                y: (y - canvas.height / 2) / (canvas.height * 0.4),
                                r, g, b
                            });
                        }
                    }
                    
                    encryptedPoints = points;
                    document.getElementById('canvasInfo').innerHTML = `
                        <p class="text-blue-400">Image loaded for decryption</p>
                        <p class="text-sm">Points: ${points.length}</p>
                    `;
                };
                img.src = URL.createObjectURL(file);
            }
        }

        function showProgress(message) {
            document.getElementById('status').textContent = message;
            document.getElementById('progress-container').classList.remove('hidden');
            updateProgress(0);
        }

        function updateProgress(percent) {
            document.getElementById('progress-bar-fill').style.width = `${percent}%`;
        }

        function hideProgress() {
            document.getElementById('progress-container').classList.add('hidden');
        }

        // Enhanced Security Functions
        
        function updateSecurityDashboard() {
            document.getElementById('encryptedFilesCount').textContent = securityStats.encryptedFiles;
            document.getElementById('totalSecurityScore').textContent = securityStats.securityScore;
            document.getElementById('activeKeys').textContent = securityStats.activeKeys;
        }

        async function bulkEncryptFiles() {
            if (currentCases.length === 0) {
                alert('No cases available for bulk encryption');
                return;
            }

            try {
                showProgress('Bulk encrypting files...');
                
                const authToken = localStorage.getItem('authToken');
                let totalEncrypted = 0;
                
                for (const caseData of currentCases) {
                    for (const file of caseData.files) {
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/cases/${caseData.id}/files/${file.id}/encrypt`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${authToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    multiLayer: true,
                                    securityLevel: document.getElementById('securityLevel').value
                                })
                            });
                            
                            if (response.ok) {
                                totalEncrypted++;
                                securityStats.encryptedFiles++;
                            }
                        } catch (error) {
                            console.error(`Error encrypting file ${file.name}:`, error);
                        }
                    }
                }
                
                securityStats.securityScore = Math.min(100, securityStats.encryptedFiles * 10);
                updateSecurityDashboard();
                
                document.getElementById('canvasInfo').innerHTML = `
                    <p class="text-green-400">Bulk encryption completed!</p>
                    <p class="text-sm">Encrypted ${totalEncrypted} files</p>
                `;
                
                hideProgress();
            } catch (error) {
                console.error('Bulk encryption error:', error);
                alert('Bulk encryption failed');
                hideProgress();
            }
        }

        async function performSecurityAudit() {
            try {
                showProgress('Performing security audit...');
                
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/security/audit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const audit = await response.json();
                    
                    document.getElementById('canvasInfo').innerHTML = `
                        <div class="text-center">
                            <h3 class="text-lg font-semibold text-white mb-2">Security Audit Results</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-gray-600 p-2 rounded">
                                    <div class="font-bold">${audit.encryptedFiles}</div>
                                    <div>Encrypted Files</div>
                                </div>
                                <div class="bg-gray-600 p-2 rounded">
                                    <div class="font-bold">${audit.securityScore}/100</div>
                                    <div>Security Score</div>
                                </div>
                                <div class="bg-gray-600 p-2 rounded">
                                    <div class="font-bold">${audit.vulnerabilities}</div>
                                    <div>Vulnerabilities</div>
                                </div>
                                <div class="bg-gray-600 p-2 rounded">
                                    <div class="font-bold">${audit.recommendations}</div>
                                    <div>Recommendations</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    securityStats.securityScore = audit.securityScore;
                    updateSecurityDashboard();
                } else {
                    throw new Error('Security audit failed');
                }
                
                hideProgress();
            } catch (error) {
                console.error('Security audit error:', error);
                alert('Security audit failed');
                hideProgress();
            }
        }

        async function rotateEncryptionKeys() {
            if (!confirm('This will generate new encryption keys. Existing encrypted files will need to be re-encrypted. Continue?')) {
                return;
            }

            try {
                showProgress('Rotating encryption keys...');
                
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/security/rotate-keys`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    document.getElementById('canvasInfo').innerHTML = `
                        <p class="text-green-400">Key rotation completed!</p>
                        <p class="text-sm">New keys generated: ${result.newKeys}</p>
                        <p class="text-sm">Files requiring re-encryption: ${result.filesToReencrypt}</p>
                    `;
                    
                    securityStats.activeKeys = result.newKeys;
                    updateSecurityDashboard();
                } else {
                    throw new Error('Key rotation failed');
                }
                
                hideProgress();
            } catch (error) {
                console.error('Key rotation error:', error);
                alert('Key rotation failed');
                hideProgress();
            }
        }

        function updateSecuritySettings() {
            const securityLevel = document.getElementById('securityLevel').value;
            
            // Update checkboxes based on security level
            const fractalLayer = document.getElementById('fractalLayer');
            const aesLayer = document.getElementById('aesLayer');
            const rsaLayer = document.getElementById('rsaLayer');
            const customLayer = document.getElementById('customLayer');
            
            switch (securityLevel) {
                case 'standard':
                    fractalLayer.checked = true;
                    aesLayer.checked = true;
                    rsaLayer.checked = false;
                    customLayer.checked = false;
                    break;
                case 'high':
                    fractalLayer.checked = true;
                    aesLayer.checked = true;
                    rsaLayer.checked = true;
                    customLayer.checked = false;
                    break;
                case 'maximum':
                    fractalLayer.checked = true;
                    aesLayer.checked = true;
                    rsaLayer.checked = true;
                    customLayer.checked = true;
                    break;
            }
        }

        // Enhanced encryption with multi-layer support
        async function encryptFileWithLayers(data, layers) {
            let encryptedData = data;
            
            for (const layer of layers) {
                switch (layer) {
                    case 'fractal':
                        encryptedData = await encryptWithFractal(encryptedData);
                        break;
                    case 'aes':
                        encryptedData = await encryptWithAES(encryptedData);
                        break;
                    case 'rsa':
                        encryptedData = await encryptWithRSA(encryptedData);
                        break;
                    case 'custom':
                        encryptedData = await encryptWithCustom(encryptedData);
                        break;
                }
            }
            
            return encryptedData;
        }

        async function encryptWithFractal(data) {
            // Use existing fractal encryption
            return await pythonProcessor.encryptFile(data);
        }

        async function encryptWithAES(data) {
            // Simulate AES encryption
            const key = await crypto.subtle.generateKey(
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            
            return new Uint8Array(encrypted);
        }

        async function encryptWithRSA(data) {
            // Simulate RSA encryption
            const keyPair = await crypto.subtle.generateKey(
                { name: 'RSA-OAEP', modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]) },
                true,
                ['encrypt', 'decrypt']
            );
            
            const encrypted = await crypto.subtle.encrypt(
                { name: 'RSA-OAEP' },
                keyPair.publicKey,
                data
            );
            
            return new Uint8Array(encrypted);
        }

        async function encryptWithCustom(data) {
            // Custom encryption algorithm inspired by crypt-tick
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const key = await crypto.subtle.importKey(
                'raw',
                salt,
                { name: 'PBKDF2' },
                false,
                ['deriveBits', 'deriveKey']
            );
            
            const derivedKey = await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: salt, iterations: 100000, hash: 'SHA-256' },
                key,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt', 'decrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                derivedKey,
                data
            );
            
            return new Uint8Array(encrypted);
        }
    </script>
</body>
</html>

