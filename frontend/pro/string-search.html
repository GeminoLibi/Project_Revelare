<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Search - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <!-- Upgrade Redirect Script -->
    <script src="/js/upgrade-redirect.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #1E293B;
            border-top: 4px solid #3B82F6;
        }
        .search-result {
            background-color: #1E293B;
            border-left: 4px solid #10B981;
            transition: all 0.3s ease;
        }
        .search-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .match-highlight {
            background-color: #FEF3C7;
            color: #92400E;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }
        .context-text {
            font-family: 'Courier New', monospace;
            background-color: #374151;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #4B5563;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <main class="pt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">String & Pattern Search</h1>
                <p class="text-gray-400">Search for specific strings or regular expressions within your case files</p>
            </div>

            <!-- Search Configuration -->
            <div class="card p-6 rounded-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-search-plus text-blue-500"></i> Configure Search
                </h2>
                <form id="searchForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Case</label>
                            <select id="caseSelect" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" required>
                                <option value="">Choose a case...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Context Characters</label>
                            <input type="number" id="contextChars" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" 
                                   value="100" min="20" max="500">
                            <p class="text-sm text-gray-400 mt-1">Number of characters to show around each match (20-500)</p>
                        </div>
                    </div>
                    
                    <div class="form-group mt-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Search Strings or Patterns</label>
                        <textarea id="searchStrings" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" 
                                  rows="4" placeholder="Enter strings separated by commas (e.g., password, secret, api_key)&#10;Or enter a single Regular Expression if Regex mode is enabled." required></textarea>
                        <p class="text-sm text-gray-400 mt-1">Enter one or more literal strings (comma-separated), or a single regex pattern.</p>
                    </div>

                    <div class="form-group">
                        <label class="flex items-center">
                            <input type="checkbox" id="useRegex" class="mr-2">
                            <span class="text-gray-300">Enable Regular Expression (Regex) Search</span>
                        </label>
                        <p class="text-sm text-gray-400 mt-1">Treat the input as a single regex pattern instead of comma-separated strings. Example: <code class="bg-gray-800 px-1 rounded">\b\d{3}-\d{2}-\d{4}\b</code> to find SSNs.</p>
                    </div>

                    <div class="form-actions mt-6">
                        <button type="submit" class="btn btn-primary btn-large">
                            <i class="fas fa-search"></i> Search Files
                        </button>
                        <button type="button" id="clearResults" class="btn btn-outline">
                            <i class="fas fa-trash"></i> Clear Results
                        </button>
                    </div>
                </form>
            </div>

            <!-- Search Results -->
            <div id="searchResults" class="hidden">
                <div class="card p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white">
                            <i class="fas fa-list text-green-500"></i> Search Results
                        </h2>
                        <div id="searchLoading" class="loading-spinner hidden"></div>
                    </div>
                    <div id="resultsContent">
                        <!-- Results will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://project-revelare-backend.liberatorgeminorum.workers.dev';
        
        let currentCases = [];

        // Load navigation component
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navigation.html');
                const html = await response.text();
                document.getElementById('navigation-container').innerHTML = html;
                
                // Load navigation JavaScript after component is loaded
                const script = document.createElement('script');
                script.src = '/js/navigation.js';
                document.head.appendChild(script);
                
                // Load cases after navigation is ready
                setTimeout(loadCases, 1000);
            } catch (error) {
                console.error('Failed to load navigation:', error);
            }
        });

        // Load user's cases
        async function loadCases() {
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentCases = data.cases || [];
                    populateCaseSelect();
                } else {
                    throw new Error('Failed to load cases');
                }
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('caseSelect').innerHTML = '<option value="">Error loading cases</option>';
            }
        }

        function populateCaseSelect() {
            const select = document.getElementById('caseSelect');
            select.innerHTML = '<option value="">Choose a case...</option>';
            
            currentCases.forEach(case => {
                const option = document.createElement('option');
                option.value = case.id;
                option.textContent = `${case.name} (${case.files.length} files)`;
                select.appendChild(option);
            });
        }

        // Handle search form submission
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const caseId = document.getElementById('caseSelect').value;
            const searchStringsText = document.getElementById('searchStrings').value.trim();
            const contextChars = parseInt(document.getElementById('contextChars').value);
            const useRegex = document.getElementById('useRegex').checked;
            
            if (!caseId) {
                alert('Please select a case');
                return;
            }
            
            if (!searchStringsText) {
                alert('Please enter search strings');
                return;
            }
            
            // Parse search strings
            let searchStrings;
            if (useRegex) {
                searchStrings = [searchStringsText];
            } else {
                searchStrings = searchStringsText.split(',').map(s => s.trim()).filter(s => s.length > 0);
            }
            
            if (searchStrings.length === 0) {
                alert('Please enter valid search strings');
                return;
            }
            
            await performSearch(caseId, searchStrings, contextChars, useRegex);
        });

        async function performSearch(caseId, searchStrings, contextChars, useRegex) {
            try {
                document.getElementById('searchLoading').classList.remove('hidden');
                document.getElementById('searchResults').classList.remove('hidden');
                
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases/${caseId}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        searchStrings,
                        contextChars,
                        useRegex
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data.results, searchStrings);
                } else {
                    throw new Error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('resultsContent').innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            } finally {
                document.getElementById('searchLoading').classList.add('hidden');
            }
        }

        function displaySearchResults(results, searchStrings) {
            const container = document.getElementById('resultsContent');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>No matches found for the specified search terms.</p>
                    </div>
                `;
                return;
            }

            // Group results by file
            const resultsByFile = {};
            results.forEach(result => {
                if (!resultsByFile[result.file_name]) {
                    resultsByFile[result.file_name] = [];
                }
                resultsByFile[result.file_name].push(result);
            });

            container.innerHTML = `
                <div class="mb-4">
                    <p class="text-gray-300">Found <span class="text-blue-400 font-semibold">${results.length}</span> matches across <span class="text-blue-400 font-semibold">${Object.keys(resultsByFile).length}</span> files</p>
                </div>
                ${Object.entries(resultsByFile).map(([fileName, fileResults]) => `
                    <div class="search-result p-4 rounded-lg mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold text-white">
                                <i class="fas fa-file text-blue-400"></i> ${fileName}
                            </h3>
                            <span class="px-2 py-1 bg-gray-600 text-white text-sm rounded">
                                ${fileResults.length} match${fileResults.length !== 1 ? 'es' : ''}
                            </span>
                        </div>
                        <div class="space-y-3">
                            ${fileResults.map(result => `
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-gray-400">
                                            Position: ${result.position}
                                        </span>
                                        <span class="text-sm text-gray-400">
                                            Search: "${result.search_string}"
                                        </span>
                                    </div>
                                    <div class="context-text">
                                        ${highlightMatch(result.context, result.match)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function highlightMatch(context, match) {
            // Simple highlighting - replace the match with highlighted version
            const regex = new RegExp(`(${escapeRegExp(match)})`, 'gi');
            return context.replace(regex, '<span class="match-highlight">$1</span>');
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Clear results
        document.getElementById('clearResults').addEventListener('click', function() {
            document.getElementById('searchResults').classList.add('hidden');
            document.getElementById('resultsContent').innerHTML = '';
        });
    </script>
</body>
</html>

