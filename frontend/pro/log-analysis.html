<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analysis - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #1E293B;
            border-top: 4px solid #3B82F6;
        }
        .premium-card {
            background-color: #1E293B;
            border-left: 4px solid #F59E0B;
            position: relative;
        }
        .premium-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: linear-gradient(45deg, #F59E0B, #F97316);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .threat-high {
            background-color: #7F1D1D;
            border-left: 4px solid #EF4444;
        }
        .threat-medium {
            background-color: #78350F;
            border-left: 4px solid #F59E0B;
        }
        .threat-low {
            background-color: #1E3A8A;
            border-left: 4px solid #3B82F6;
        }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #F59E0B;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <main class="pt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Log Analysis</h1>
                <p class="text-gray-400">Advanced log parsing and threat detection powered by Panomreles</p>
                <div class="mt-2">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-900 text-yellow-200">
                        <i class="fas fa-crown mr-2"></i>
                        Professional Tier Feature
                    </span>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- File Selection -->
                <div class="card p-6 rounded-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">
                        <i class="fas fa-file-alt text-blue-500"></i> Select Log File
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Case</label>
                            <select id="caseSelect" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a case...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Log File</label>
                            <select id="fileSelect" class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select a file...</option>
                            </select>
                        </div>
                        
                        <button id="analyzeBtn" onclick="analyzeLogFile()" 
                                class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-search mr-2"></i>
                            Analyze Log File
                        </button>
                        
                        <div id="loadingIndicator" class="hidden text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-gray-400">Analyzing log file...</p>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Log Type Detection -->
                    <div class="premium-card p-6 rounded-lg">
                        <div class="premium-badge">PROFESSIONAL</div>
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-microscope text-yellow-500"></i> Log Analysis Results
                        </h3>
                        <div id="analysisResults" class="hidden">
                            <!-- Results will be populated here -->
                        </div>
                        <div id="noResults" class="text-center text-gray-400 py-8">
                            <i class="fas fa-file-alt text-4xl mb-4"></i>
                            <p>Select a log file to begin analysis</p>
                        </div>
                    </div>

                    <!-- Threat Detection -->
                    <div class="premium-card p-6 rounded-lg">
                        <div class="premium-badge">PROFESSIONAL</div>
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-shield-alt text-red-500"></i> Threat Detection
                        </h3>
                        <div id="threatResults" class="hidden">
                            <!-- Threat results will be populated here -->
                        </div>
                        <div id="noThreats" class="text-center text-gray-400 py-8">
                            <i class="fas fa-shield-check text-4xl mb-4"></i>
                            <p>No threats detected</p>
                        </div>
                    </div>

                    <!-- Anomaly Detection -->
                    <div class="premium-card p-6 rounded-lg">
                        <div class="premium-badge">PROFESSIONAL</div>
                        <h3 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-exclamation-triangle text-orange-500"></i> Anomaly Detection
                        </h3>
                        <div id="anomalyResults" class="hidden">
                            <!-- Anomaly results will be populated here -->
                        </div>
                        <div id="noAnomalies" class="text-center text-gray-400 py-8">
                            <i class="fas fa-check-circle text-4xl mb-4"></i>
                            <p>No anomalies detected</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navigation.html');
                const html = await response.text();
                document.getElementById('navigation-container').innerHTML = html;
                
                // Load navigation JavaScript after component is loaded
                const script = document.createElement('script');
                script.src = '/js/navigation.js';
                document.head.appendChild(script);
            } catch (error) {
                console.error('Failed to load navigation:', error);
            }
        });

        // Load cases and files
        async function loadCases() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/api/cases', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const caseSelect = document.getElementById('caseSelect');
                caseSelect.innerHTML = '<option value="">Select a case...</option>';
                
                if (data.success && data.cases) {
                    data.cases.forEach(case_ => {
                        const option = document.createElement('option');
                        option.value = case_.id;
                        option.textContent = `${case_.case_number} - ${case_.status}`;
                        caseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading cases:', error);
            }
        }

        // Load files when case is selected
        document.getElementById('caseSelect').addEventListener('change', async function() {
            const caseId = this.value;
            const fileSelect = document.getElementById('fileSelect');
            fileSelect.innerHTML = '<option value="">Select a file...</option>';

            if (!caseId) return;

            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/cases/${caseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.case.files) {
                    data.case.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.id;
                        option.textContent = file.name;
                        fileSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        });

        async function analyzeLogFile() {
            const caseId = document.getElementById('caseSelect').value;
            const fileId = document.getElementById('fileSelect').value;
            
            if (!caseId || !fileId) {
                alert('Please select a case and file');
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in to analyze log files');
                return;
            }

            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('analyzeBtn').disabled = true;

                const response = await fetch(`/api/cases/${caseId}/files/${fileId}/analyze-logs`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    displayAnalysisResults(data.analysis);
                } else {
                    alert('Analysis failed: ' + data.message);
                }
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Analysis failed: ' + error.message);
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function displayAnalysisResults(analysis) {
            // Hide no results message
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('analysisResults').classList.remove('hidden');

            // Display basic analysis
            const analysisDiv = document.getElementById('analysisResults');
            analysisDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-400">${analysis.analysis.total_logs}</div>
                        <div class="text-sm text-gray-400">Total Logs</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-400">${analysis.analysis.error_logs}</div>
                        <div class="text-sm text-gray-400">Errors</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-400">${analysis.analysis.success_logs}</div>
                        <div class="text-sm text-gray-400">Success</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-400">${analysis.analysis.error_rate.toFixed(1)}%</div>
                        <div class="text-sm text-gray-400">Error Rate</div>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-white mb-3">Log Type: ${analysis.log_type}</h4>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <p class="text-gray-300">Detected log format: <span class="text-blue-400 font-semibold">${analysis.log_type.replace('_', ' ').toUpperCase()}</span></p>
                        <p class="text-gray-300 mt-2">Parsed entries: <span class="text-green-400 font-semibold">${analysis.total_parsed}</span></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Top IP Addresses</h4>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            ${Object.entries(analysis.analysis.top_ips).slice(0, 5).map(([ip, count]) => 
                                `<div class="flex justify-between py-1">
                                    <span class="text-gray-300">${ip}</span>
                                    <span class="text-blue-400 font-semibold">${count}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold text-white mb-3">Status Codes</h4>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            ${Object.entries(analysis.analysis.status_codes).slice(0, 5).map(([status, count]) => 
                                `<div class="flex justify-between py-1">
                                    <span class="text-gray-300">${status}</span>
                                    <span class="text-green-400 font-semibold">${count}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;

            // Display threats
            if (analysis.analysis.threat_indicators && analysis.analysis.threat_indicators.length > 0) {
                document.getElementById('noThreats').classList.add('hidden');
                document.getElementById('threatResults').classList.remove('hidden');
                
                const threatDiv = document.getElementById('threatResults');
                threatDiv.innerHTML = analysis.analysis.threat_indicators.map(threat => `
                    <div class="threat-${threat.severity} p-4 rounded-lg mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-semibold text-white">${threat.threat_type}</h5>
                                <p class="text-sm text-gray-300 mt-1">${threat.log_entry.original_line.substring(0, 100)}...</p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-semibold ${
                                threat.severity === 'high' ? 'bg-gray-600 text-white' :
                                threat.severity === 'medium' ? 'bg-gray-600 text-white' :
                                'bg-gray-600 text-white'
                            }">
                                ${threat.severity.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('');
            }

            // Display anomalies
            if (analysis.analysis.anomalies && analysis.analysis.anomalies.length > 0) {
                document.getElementById('noAnomalies').classList.add('hidden');
                document.getElementById('anomalyResults').classList.remove('hidden');
                
                const anomalyDiv = document.getElementById('anomalyResults');
                anomalyDiv.innerHTML = analysis.analysis.anomalies.map(anomaly => `
                    <div class="bg-gray-800 p-4 rounded-lg mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-semibold text-white">${anomaly.type}</h5>
                                <p class="text-sm text-gray-300 mt-1">
                                    ${anomaly.ip ? `IP: ${anomaly.ip}` : ''}
                                    ${anomaly.status_code ? `Status: ${anomaly.status_code}` : ''}
                                    ${anomaly.request_count ? `Requests: ${anomaly.request_count}` : ''}
                                    ${anomaly.count ? `Count: ${anomaly.count}` : ''}
                                </p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-semibold ${
                                anomaly.severity === 'high' ? 'bg-gray-600 text-white' :
                                anomaly.severity === 'medium' ? 'bg-gray-600 text-white' :
                                'bg-gray-600 text-white'
                            }">
                                ${anomaly.severity.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Load cases on page load
        loadCases();
    </script>
</body>
</html>

