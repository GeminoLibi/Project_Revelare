<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Analysis - Project Revelare</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3891410174900441"
         crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #F8FAFC;
        }
        h1, h2, h3, h4 {
            font-family: 'Orbitron', sans-serif;
        }
        .card {
            background-color: #1E293B;
            border-top: 4px solid #3B82F6;
        }
        .analysis-card {
            background-color: #1E293B;
            border-left: 4px solid #10B981;
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .connection-node {
            background-color: #3B82F6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.25rem;
            display: inline-block;
            font-size: 0.875rem;
        }
        .connection-link {
            background-color: #10B981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            margin: 0.25rem;
            display: inline-block;
            font-size: 0.75rem;
        }
        .loading-spinner {
            border: 3px solid #374151;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 400px;
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <main class="pt-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">Link Analysis</h1>
                <p class="text-gray-400">Visually map connections for a specific indicator across all your cases</p>
            </div>

            <!-- Search Configuration -->
            <div class="card p-6 rounded-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">
                    <i class="fas fa-project-diagram text-blue-500"></i> Search For Connections
                </h2>
                <form id="analysisForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Case</label>
                            <select id="caseSelect" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" required>
                                <option value="">Choose a case...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Indicator to Search For</label>
                            <input type="text" id="searchTerm" class="w-full bg-gray-700 text-white px-3 py-2 rounded-md border border-gray-600" 
                                   placeholder="Enter IP address, email, URL, etc." required>
                            <p class="text-sm text-gray-400 mt-1">Find which cases a specific piece of evidence appears in and discover related cases.</p>
                        </div>
                    </div>
                    
                    <div class="form-actions mt-6">
                        <button type="submit" class="btn btn-primary btn-large">
                            <i class="fas fa-project-diagram"></i> Analyze Links
                        </button>
                        <button type="button" id="clearAnalysis" class="btn btn-outline">
                            <i class="fas fa-trash"></i> Clear Analysis
                        </button>
                    </div>
                </form>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" class="hidden">
                <div class="card p-6 rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-white">
                            <i class="fas fa-list-ul text-green-500"></i> Analysis Results
                        </h2>
                        <div id="analysisLoading" class="loading-spinner hidden"></div>
                    </div>
                    <div id="analysisContent">
                        <!-- Analysis will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://project-revelare-backend.liberatorgeminorum.workers.dev';
        
        let currentCases = [];
        let analysisChart = null;

        // Load navigation component
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/components/navigation.html');
                const html = await response.text();
                document.getElementById('navigation-container').innerHTML = html;
                
                // Load navigation JavaScript after component is loaded
                const script = document.createElement('script');
                script.src = '/js/navigation.js';
                document.head.appendChild(script);
                
                // Load cases after navigation is ready
                setTimeout(loadCases, 1000);
            } catch (error) {
                console.error('Failed to load navigation:', error);
            }
        });

        // Load user's cases
        async function loadCases() {
            try {
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentCases = data.cases || [];
                    populateCaseSelect();
                } else {
                    throw new Error('Failed to load cases');
                }
            } catch (error) {
                console.error('Error loading cases:', error);
                document.getElementById('caseSelect').innerHTML = '<option value="">Error loading cases</option>';
            }
        }

        function populateCaseSelect() {
            const select = document.getElementById('caseSelect');
            select.innerHTML = '<option value="">Choose a case...</option>';
            
            currentCases.forEach(case => {
                const option = document.createElement('option');
                option.value = case.id;
                option.textContent = `${case.name} (${Object.keys(case.findings).length - 1} indicators)`;
                select.appendChild(option);
            });
        }

        // Handle analysis form submission
        document.getElementById('analysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const caseId = document.getElementById('caseSelect').value;
            const searchTerm = document.getElementById('searchTerm').value.trim();
            
            if (!caseId) {
                alert('Please select a case');
                return;
            }
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            await performAnalysis(caseId, searchTerm);
        });

        async function performAnalysis(caseId, searchTerm) {
            try {
                document.getElementById('analysisLoading').classList.remove('hidden');
                document.getElementById('analysisResults').classList.remove('hidden');
                
                const authToken = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/api/cases/${caseId}/analyze-links`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        searchTerm
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAnalysisResults(data.analysis, searchTerm);
                } else {
                    throw new Error('Analysis failed');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('analysisContent').innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Analysis failed. Please try again.</p>
                    </div>
                `;
            } finally {
                document.getElementById('analysisLoading').classList.add('hidden');
            }
        }

        function displayAnalysisResults(analysis, searchTerm) {
            const container = document.getElementById('analysisContent');
            
            if (analysis.direct_links.length === 0 && analysis.secondary_links.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>No connections found for "${searchTerm}".</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2">Analysis for "${searchTerm}"</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-600 p-3 rounded text-center">
                            <div class="text-2xl font-bold">${analysis.direct_links.length}</div>
                            <div class="text-sm">Direct Hits</div>
                        </div>
                        <div class="bg-gray-600 p-3 rounded text-center">
                            <div class="text-2xl font-bold">${analysis.secondary_links.length}</div>
                            <div class="text-sm">Secondary Links</div>
                        </div>
                        <div class="bg-gray-600 p-3 rounded text-center">
                            <div class="text-2xl font-bold">${analysis.direct_links.length + analysis.secondary_links.length}</div>
                            <div class="text-sm">Total Connections</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Connection Graph -->
                    <div class="analysis-card p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-project-diagram text-blue-400"></i> Connection Graph
                        </h4>
                        <div class="chart-container">
                            <canvas id="connectionChart"></canvas>
                        </div>
                    </div>

                    <!-- Direct Hits -->
                    <div class="analysis-card p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-bullseye text-green-400"></i> Direct Hits
                        </h4>
                        ${analysis.direct_links.length > 0 ? `
                            <div class="space-y-3">
                                ${analysis.direct_links.map(link => `
                                    <div class="bg-gray-800 p-3 rounded">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="connection-node">${link.category}</span>
                                            <span class="text-sm text-gray-400">${link.indicator}</span>
                                        </div>
                                        <div class="text-sm text-gray-300">${link.context}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center text-gray-400 py-4">
                                <i class="fas fa-info-circle text-xl mb-2"></i>
                                <p>No direct matches found</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Secondary Links -->
                ${analysis.secondary_links.length > 0 ? `
                    <div class="analysis-card p-4 rounded-lg mt-6">
                        <h4 class="text-lg font-semibold text-white mb-4">
                            <i class="fas fa-link text-yellow-400"></i> Secondary Links
                        </h4>
                        <div class="space-y-3">
                            ${analysis.secondary_links.map(link => `
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="connection-link">${link.connection_type || 'related'}</span>
                                        <span class="text-sm text-gray-400">${link.category}</span>
                                    </div>
                                    <div class="text-sm text-gray-300 mb-1">${link.indicator}</div>
                                    <div class="text-sm text-gray-400">${link.context}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            // Create connection chart
            createConnectionChart(analysis);
        }

        function createConnectionChart(analysis) {
            const ctx = document.getElementById('connectionChart').getContext('2d');
            
            // Destroy existing chart
            if (analysisChart) {
                analysisChart.destroy();
            }

            // Prepare data for the chart
            const categories = {};
            analysis.direct_links.forEach(link => {
                categories[link.category] = (categories[link.category] || 0) + 1;
            });
            analysis.secondary_links.forEach(link => {
                categories[link.category] = (categories[link.category] || 0) + 1;
            });

            const labels = Object.keys(categories);
            const data = Object.values(categories);
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
            ];

            analysisChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: '#1E293B',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#F8FAFC',
                                font: {
                                    family: 'Inter'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Connections by Category',
                            color: '#F8FAFC',
                            font: {
                                family: 'Orbitron',
                                size: 16
                            }
                        }
                    }
                }
            });
        }

        // Clear analysis
        document.getElementById('clearAnalysis').addEventListener('click', function() {
            document.getElementById('analysisResults').classList.add('hidden');
            document.getElementById('analysisContent').innerHTML = '';
            if (analysisChart) {
                analysisChart.destroy();
                analysisChart = null;
            }
        });
    </script>
</body>
</html>

